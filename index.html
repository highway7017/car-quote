<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¹„ëŒ€ë©´ ì°¨ëŸ‰ ê²¬ì  ìƒë‹´</title>

  <style>
    /* =========================
       0) ë°°ê²½ ì´ë¯¸ì§€ íŒŒì¼ëª…ë§Œ ì—¬ê¸°ì„œ ë°”ê¾¸ê¸°
       ========================= */
    :root{
      --bg-url: url("bg.png"); /* âœ… ì—¬ê¸°ë¥¼ ë„¤ ì´ë¯¸ì§€ íŒŒì¼ëª…ìœ¼ë¡œ */
      --pink-1: rgba(255, 214, 236, .95);
      --pink-2: rgba(255, 170, 214, .72);
      --pink-3: rgba(255, 120, 186, .72);
      --text: #221a23;
      --muted: rgba(34, 26, 35, .62);
      --card: rgba(255,255,255,.78);
      --stroke: rgba(255,255,255,.60);
      --shadow: 0 18px 55px rgba(0,0,0,.18);
    }

    /* =========================
       1) í˜ì´ì§€ ì „ì²´ ë°°ê²½ ë ˆì´ì–´
       - cover ê¸ˆì§€
       - ì´ë¯¸ì§€ 1íšŒë§Œ + ì›ë³¸ë¹„ìœ¨ ìœ ì§€ (contain)
       - ì•„ë˜ë¡œ íˆ¬ëª… ê·¸ë¼ë°ì´ì…˜ â†’ í•‘í¬ ë°°ê²½ ì—°ê²°
       ========================= */
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      color: var(--text);
      position: relative;
      overflow-x:hidden;

      /* âœ… í•‘í¬í†¤ ë°”íƒ• (ì´ë¯¸ì§€ê°€ ì‚¬ë¼ì§„ ë’¤ ì´ì–´ì§ˆ ë°°ê²½) */
      background:
        radial-gradient(1200px 700px at 50% 0%, rgba(255,255,255,.70), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, #ffe7f3 0%, #ffd4ee 40%, #ffc0e6 70%, #ffb2df 100%);
    }

    /* ë°°ê²½ ì´ë¯¸ì§€(ì›ë³¸ ë¹„ìœ¨ ìœ ì§€ / 1íšŒë§Œ / contain ëŠë‚Œ) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -2;

      /* âœ… cover ì•„ë‹ˆë¼ contain */
      background-image: var(--bg-url);
      background-repeat: no-repeat;
      background-position: center top;
      background-size: min(1200px, 100%) auto; /* í™”ë©´ ë„ˆë¹„ì— ë§ì¶° â€œë”±â€ ë³´ì´ê²Œ */
      /* â†‘ 1200pxëŠ” PCì—ì„œ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ ì œí•œ. ì›í•˜ë©´ ìˆ«ì ì¡°ì ˆ ê°€ëŠ¥ */

      /* ì´ë¯¸ì§€ê°€ ë„ˆë¬´ ê°•í•˜ë©´ ì‚´ì§ íˆ¬ëª… */
      opacity: .95;
      transform: translateZ(0);
    }

    /* ì´ë¯¸ì§€ ì•„ë˜ë¥¼ íˆ¬ëª…ìœ¼ë¡œ â€œë…¹ì—¬ì„œâ€ í•‘í¬ë¡œ ì—°ê²°í•˜ëŠ” ë ˆì´ì–´ */
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;

      /* âœ… í•µì‹¬: ìœ„ìª½ì€ íˆ¬ëª…, ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ í•‘í¬ê°€ ì˜¬ë¼ì˜¤ê²Œ */
      background:
        linear-gradient(
          180deg,
          rgba(255, 232, 245, 0) 0%,
          rgba(255, 232, 245, 0) 35%,
          rgba(255, 232, 245, .35) 55%,
          rgba(255, 214, 236, .75) 72%,
          rgba(255, 170, 214, .86) 88%,
          rgba(255, 120, 186, .92) 100%
        );
      transform: translateZ(0);
    }

    /* =========================
       2) ë ˆì´ì•„ì›ƒ/ì¹´ë“œ
       ========================= */
    .wrap{
      max-width: 980px;
      margin: 32px auto 90px;
      padding: 0 16px;
    }

    .shell{
      border-radius: 26px;
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.32);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    /* ìƒë‹¨ "ë°°ë„ˆì²˜ëŸ¼" ë³´ì´ëŠ” ì˜ì—­ */
    .hero{
      padding: 28px 18px 24px;
      text-align:center;
      position: relative;
      background:
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.05));
    }

    .hero h1{
      margin:0;
      font-size: 28px;
      letter-spacing: -0.6px;
      font-weight: 900;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }
    .hero p{
      margin:10px 0 0;
      font-weight: 800;
      color: var(--muted);
      font-size: 13px;
    }

    .content{ padding: 18px; }

    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1.1fr .9fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 16px;
      box-shadow: 0 10px 35px rgba(0,0,0,.08);
      backdrop-filter: blur(12px);
    }

    .sec-title{
      display:flex;
      align-items:center;
      gap:10px;
      margin:0 0 10px;
      font-size: 15px;
      font-weight: 900;
    }
    .badge{
      font-size: 12px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,95,179,.14);
      border: 1px solid rgba(255,95,179,.18);
      color: #a20b5a;
    }

    label{
      display:block;
      font-weight: 900;
      margin-top: 12px;
      font-size: 13px;
    }
    input, select, textarea{
      width: 100%;
      margin-top: 8px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.92);
      outline: none;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,95,179,.55);
      box-shadow: 0 0 0 3px rgba(255,95,179,.16);
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 560px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .radio-group{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.86);
      font-weight: 900;
      cursor: pointer;
      user-select:none;
    }
    .pill input{ width:auto; margin:0; }

    .small{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-top: 8px;
      line-height: 1.35;
    }

    .price{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .price .box{
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.78);
      padding: 12px;
      text-align:center;
    }
    .price .box .k{ font-size: 12px; font-weight: 900; color: var(--muted); }
    .price .box .v{ margin-top: 6px; font-size: 18px; font-weight: 900; }

    .btn{
      margin-top: 16px;
      width: 100%;
      padding: 14px 14px;
      border: none;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 1000;
      color: white;
      cursor: pointer;
      background: linear-gradient(90deg, rgba(255,95,179,1), rgba(157,120,255,1));
      box-shadow: 0 14px 35px rgba(255,95,179,.25);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .agree{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top: 14px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.78);
    }
    .agree input{ width:auto; margin-top: 2px; }
    .agree .txt{ font-size: 12px; color: var(--muted); font-weight: 800; line-height: 1.35; }
    .agree .txt strong{ color: var(--text); }

    .toast{
      margin-top: 10px;
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,26,35,.75);
      text-align:center;
    }

    /* ì˜µì…˜ ì²´í¬ë°•ìŠ¤ ë¦¬ìŠ¤íŠ¸ */
    .opt-list{
      margin-top: 8px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.86);
    }
    .opt input{ width:auto; margin-top: 3px; }
    .opt .name{ font-weight: 900; }
    .opt .won{ color: var(--muted); font-weight: 900; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="hero">
        <h1>ë¹„ëŒ€ë©´ ì°¨ëŸ‰ ê²¬ì  ìƒë‹´</h1>
        <p>ê°„ë‹¨í•œ ì¡°ê±´ ì…ë ¥ìœ¼ë¡œ ë¹„ëŒ€ë©´ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤</p>
      </div>

      <div class="content">
        <div class="grid">

          <!-- ì¢Œì¸¡: ì°¨ëŸ‰ ì„ íƒ -->
          <div class="card">
            <div class="sec-title">ì°¨ëŸ‰ ì„ íƒ <span class="badge">í•„ìˆ˜</span></div>

            <label>ìƒë‹´ ìœ í˜•</label>
            <div class="radio-group" id="dealTypeGroup">
              <label class="pill"><input type="radio" name="dealType" value="ë ŒíŠ¸" checked> ì¥ê¸°ë ŒíŠ¸</label>
              <label class="pill"><input type="radio" name="dealType" value="ë¦¬ìŠ¤"> ë¦¬ìŠ¤</label>
            </div>

            <label>ì°¨ëŸ‰ëª… ê²€ìƒ‰</label>
            <input id="carSearch" placeholder="ì˜ˆ) ì˜ë Œí†  / ì…€í† ìŠ¤ / ì¹´ë‹ˆë°œ (ë¶€ë¶„ê²€ìƒ‰ ê°€ëŠ¥)" autocomplete="off" />
            <div class="small" id="searchHint">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ëª©ë¡ì´ ëœ¹ë‹ˆë‹¤.</div>

            <!-- ê²€ìƒ‰ ê²°ê³¼ -->
            <select id="modelSelect">
              <option value="">ì°¨ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            </select>

            <label>íŠ¸ë¦¼ ì„ íƒ</label>
            <select id="trimSelect" disabled>
              <option value="">ì°¨ëŸ‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
            </select>

            <label>ì˜µì…˜ ì„ íƒ</label>
            <div class="small" id="optHint">íŠ¸ë¦¼ ì„ íƒ í›„ ì˜µì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            <div class="opt-list" id="optionList"></div>

            <div class="price">
              <div class="box">
                <div class="k">ì°¨ëŸ‰ê°€</div>
                <div class="v" id="basePrice">0ì›</div>
              </div>
              <div class="box">
                <div class="k">ì˜µì…˜ê°€</div>
                <div class="v" id="optPrice">0ì›</div>
              </div>
              <div class="box">
                <div class="k">ì´ ì°¨ëŸ‰ê°€</div>
                <div class="v" id="totalPrice">0ì›</div>
              </div>
            </div>
          </div>

          <!-- ìš°ì¸¡: ìƒë‹´ ì¡°ê±´ + ì‹ ì²­ì ì •ë³´ -->
          <div class="card">
            <div class="sec-title">ìƒë‹´ ì¡°ê±´ <span class="badge">í•„ìˆ˜</span></div>

            <label>ì°¨ëŸ‰ ì¸ë„ ì§€ì—­</label>
            <input id="deliveryRegion" placeholder="ì˜ˆ) ê²½ê¸° ë‚¨ë¶€ / ì„œìš¸ ê°•ë‚¨" />

            <label>ê³ ê° ìœ í˜•</label>
            <div class="radio-group" id="custTypeGroup">
              <label class="pill"><input type="radio" name="custType" value="ê°œì¸" checked> ê°œì¸</label>
              <label class="pill"><input type="radio" name="custType" value="ê°œì¸ì‚¬ì—…ì"> ê°œì¸ì‚¬ì—…ì</label>
              <label class="pill"><input type="radio" name="custType" value="ë²•ì¸"> ë²•ì¸</label>
            </div>

            <label>ì°¨ëŸ‰ í•„ìš” ì‹œê¸° (ì„ íƒ)</label>
            <input id="needWhen" placeholder="ì˜ˆ) ê°€ëŠ¥í•œ ë¹¨ë¦¬ / 2ì›” ì¤‘ìˆœ / ë¯¸ì •" />
            <div class="small">* â€œë¯¸ì •â€ìœ¼ë¡œ ì…ë ¥í•´ë„ ê´œì°®ìŠµë‹ˆë‹¤.</div>

            <hr style="border:none;border-top:1px solid rgba(0,0,0,.08); margin:16px 0;">

            <div class="sec-title">ì‹ ì²­ì ì •ë³´ <span class="badge">í•„ìˆ˜</span></div>

            <div class="row2">
              <div>
                <label>ì‹ ì²­ìëª…</label>
                <input id="applicantName" placeholder="ì˜ˆ) í™ê¸¸ë™" />
              </div>
              <div>
                <label>ì—°ë½ì²˜</label>
                <input id="phone" placeholder="ì˜ˆ) 010-1234-5678" inputmode="tel" />
              </div>
            </div>

            <label>ì¹´ì¹´ì˜¤í†¡ ID (ì„ íƒ)</label>
            <input id="kakaoId" placeholder="ì˜ˆ) melody7017" />

            <div class="agree">
              <input type="checkbox" id="agree" />
              <div class="txt">
                <strong>[í•„ìˆ˜]</strong> ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.<br/>
                ìˆ˜ì§‘: ì„±ëª…, ì—°ë½ì²˜, ì¹´ì¹´ì˜¤í†¡ ID(ì„ íƒ) Â· ëª©ì : ê²¬ì /ìƒë‹´ ì•ˆë‚´ Â· ë³´ìœ : ìƒë‹´ ì™„ë£Œ í›„ 1ë…„
              </div>
            </div>

            <button class="btn" id="submitBtn" disabled>ê°„ë‹¨ ê²¬ì  ìš”ì²­í•˜ê¸°</button>
            <div class="toast" id="toast"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * âœ… ë„ˆì˜ Apps Script catalog URL ë„£ê¸°
     * ì˜ˆ) https://script.google.com/macros/s/....../exec?action=catalog
     ***********************/
    const CATALOG_URL = "PASTE_YOUR_CATALOG_URL_HERE";

    // ì‹¤ì œ ì‹ ì²­ ì œì¶œ(ì‹œíŠ¸ ì €ì¥) URL (doPost)
    const SUBMIT_URL  = "PASTE_YOUR_SUBMIT_URL_HERE";

    // ====== ì „ì—­ ìƒíƒœ ======
    let catalog = []; // Models ì‹œíŠ¸ì—ì„œ ì½ì–´ì˜¨ ì „ì²´ ëª©ë¡
    let filteredModels = [];
    let selectedModel = null;
    let selectedTrim = null;
    let selectedOptions = [];

    // ====== ìœ í‹¸ ======
    const won = (n) => (Number(n||0)).toLocaleString("ko-KR") + "ì›";

    function setToast(msg, ok=true){
      const el = document.getElementById("toast");
      el.textContent = msg || "";
      el.style.color = ok ? "rgba(34,26,35,.80)" : "#b00052";
    }

    function validate(){
      const modelOk = !!selectedModel;
      const trimOk = !!selectedTrim;
      const nameOk = document.getElementById("applicantName").value.trim().length > 0;
      const phoneOk = document.getElementById("phone").value.trim().length > 0;
      const regionOk = document.getElementById("deliveryRegion").value.trim().length > 0;
      const agreeOk = document.getElementById("agree").checked;

      document.getElementById("submitBtn").disabled = !(modelOk && trimOk && nameOk && phoneOk && regionOk && agreeOk);
    }

    function calcPrice(){
      const base = selectedTrim ? Number(selectedTrim.trim_price||0) : 0;
      const opt  = selectedOptions.reduce((sum,o)=> sum + Number(o.option_price||0), 0);
      document.getElementById("basePrice").textContent = won(base);
      document.getElementById("optPrice").textContent  = won(opt);
      document.getElementById("totalPrice").textContent= won(base + opt);
    }

    // ====== Catalog ë¶ˆëŸ¬ì˜¤ê¸° ======
    async function loadCatalog(){
      setToast("ì°¨ëŸ‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
      const res = await fetch(CATALOG_URL, { method:"GET" });
      const json = await res.json();
      catalog = json.models || [];
      setToast("");
      rebuildModelSelect("");
    }

    // ê²€ìƒ‰ì–´/ìœ í˜•(ë ŒíŠ¸/ë¦¬ìŠ¤)ì— ë”°ë¼ ëª¨ë¸ ëª©ë¡ êµ¬ì„±
    function rebuildModelSelect(keyword){
      const dealType = document.querySelector('input[name="dealType"]:checked').value; // ë ŒíŠ¸/ë¦¬ìŠ¤

      // ëª¨ë¸ ë‹¨ìœ„ë¡œ unique ë§Œë“¤ê¸°
      const map = new Map();
      for(const row of catalog){
        // ë ŒíŠ¸ ì„ íƒì´ë©´ "ë¦¬ìŠ¤ ì „ìš©" ëª¨ë¸ì€ ìˆ¨ê¹€ (ì‹œíŠ¸ì—ì„œ deal_type ê°™ì€ ì»¬ëŸ¼ì´ ìˆë‹¤ ê°€ì •)
        // ë„ˆ ì‹œíŠ¸ êµ¬ì¡°ê°€ ë‹¤ë¥´ë©´ ì—¬ê¸°ë§Œ ì‚´ì§ ë§ì¶°ì£¼ë©´ ë¨.
        const rowDeal = (row.deal_type || "ë ŒíŠ¸/ë¦¬ìŠ¤"); // "ë¦¬ìŠ¤ì „ìš©" ê°™ì€ ê°’ ê°€ì •
        if(dealType === "ë ŒíŠ¸" && rowDeal.includes("ë¦¬ìŠ¤ì „ìš©")) continue;

        const model = row.model_name;
        if(!model) continue;

        if(keyword){
          const k = keyword.toLowerCase();
          if(!model.toLowerCase().includes(k)) continue;
        }
        if(!map.has(model)){
          map.set(model, { model_name: model });
        }
      }
      filteredModels = [...map.values()].sort((a,b)=>a.model_name.localeCompare(b.model_name,"ko"));
      const sel = document.getElementById("modelSelect");
      sel.innerHTML = `<option value="">ì°¨ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>` + filteredModels.map(m=>`<option value="${m.model_name}">${m.model_name}</option>`).join("");
    }

    // ëª¨ë¸ ì„ íƒ ì‹œ íŠ¸ë¦¼ ëª©ë¡ ì±„ìš°ê¸°
    function rebuildTrimSelect(modelName){
      const trims = catalog.filter(r => r.model_name === modelName)
        .map(r => ({
          model_name: r.model_name,
          trim_name: r.trim_name,
          trim_price: r.trim_price,
          options_json: r.options_json
        }))
        .filter(t => t.trim_name);

      const sel = document.getElementById("trimSelect");
      sel.disabled = trims.length === 0;
      sel.innerHTML = `<option value="">íŠ¸ë¦¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>` + trims.map((t,i)=>(
        `<option value="${i}">${t.trim_name} (${Number(t.trim_price||0).toLocaleString()}ì›)</option>`
      )).join("");

      // íŠ¸ë¦¼ ë°ì´í„° ì €ì¥
      sel._trims = trims;
    }

    // íŠ¸ë¦¼ ì„ íƒ ì‹œ ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
    function rebuildOptions(){
      const list = document.getElementById("optionList");
      list.innerHTML = "";
      selectedOptions = [];

      if(!selectedTrim){
        document.getElementById("optHint").textContent = "íŠ¸ë¦¼ ì„ íƒ í›„ ì˜µì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤.";
        calcPrice();
        validate();
        return;
      }

      let opts = [];
      try{
        opts = JSON.parse(selectedTrim.options_json || "[]");
      }catch(e){
        opts = [];
      }

      if(!Array.isArray(opts) || opts.length === 0){
        document.getElementById("optHint").textContent = "ì„ íƒ ê°€ëŠ¥í•œ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.";
        calcPrice();
        validate();
        return;
      }
      document.getElementById("optHint").textContent = "ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)";

      for(const o of opts){
        const div = document.createElement("label");
        div.className = "opt";
        div.innerHTML = `
          <input type="checkbox" />
          <div>
            <div class="name">${o.option_name || "ì˜µì…˜"}</div>
            <div class="won">${Number(o.option_price||0).toLocaleString()}ì›</div>
          </div>
        `;
        const cb = div.querySelector("input");
        cb.addEventListener("change", ()=>{
          if(cb.checked){
            selectedOptions.push(o);
          }else{
            selectedOptions = selectedOptions.filter(x => x.option_name !== o.option_name);
          }
          calcPrice();
          validate();
        });
        list.appendChild(div);
      }
      calcPrice();
      validate();
    }

    // ====== ì œì¶œ ======
    async function submit(){
      const dealType = document.querySelector('input[name="dealType"]:checked').value;
      const custType = document.querySelector('input[name="custType"]:checked').value;

      const payload = {
        deal_type: dealType,
        customer_type: custType,
        delivery_region: document.getElementById("deliveryRegion").value.trim(),
        need_when: document.getElementById("needWhen").value.trim(),
        applicant_name: document.getElementById("applicantName").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        kakao_id: document.getElementById("kakaoId").value.trim(),

        model_name: selectedModel?.model_name || "",
        trim_name: selectedTrim?.trim_name || "",
        trim_price: selectedTrim?.trim_price || 0,

        options: selectedOptions.map(o=>({
          option_name: o.option_name,
          option_price: o.option_price
        })),

        option_total: selectedOptions.reduce((s,o)=>s+Number(o.option_price||0),0),
        total_price: (Number(selectedTrim?.trim_price||0) + selectedOptions.reduce((s,o)=>s+Number(o.option_price||0),0))
      };

      setToast("ì ‘ìˆ˜ ì¤‘ì…ë‹ˆë‹¤...");
      document.getElementById("submitBtn").disabled = true;

      try{
        const res = await fetch(SUBMIT_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if(json.ok){
          setToast("ì‹ ì²­ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹„ëŒ€ë©´ìœ¼ë¡œ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ™‚");
        }else{
          setToast("ì ‘ìˆ˜ ì‹¤íŒ¨: " + (json.message || "ì˜¤ë¥˜"), false);
        }
      }catch(e){
        setToast("ì ‘ìˆ˜ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬/URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.", false);
      }finally{
        validate();
      }
    }

    // ====== ì´ë²¤íŠ¸ ======
    document.getElementById("carSearch").addEventListener("input", (e)=>{
      rebuildModelSelect(e.target.value.trim());
    });

    document.getElementById("modelSelect").addEventListener("change", (e)=>{
      const name = e.target.value;
      selectedModel = name ? { model_name: name } : null;

      // íŠ¸ë¦¼/ì˜µì…˜ ì´ˆê¸°í™”
      selectedTrim = null;
      selectedOptions = [];
      document.getElementById("optionList").innerHTML = "";
      document.getElementById("trimSelect").innerHTML = `<option value="">íŠ¸ë¦¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>`;
      document.getElementById("trimSelect").disabled = !name;

      if(name){
        rebuildTrimSelect(name);
      }
      calcPrice();
      validate();
    });

    document.getElementById("trimSelect").addEventListener("change", (e)=>{
      const idx = e.target.value;
      const trims = e.target._trims || [];
      selectedTrim = (idx !== "" && trims[idx]) ? trims[idx] : null;
      rebuildOptions();
    });

    document.getElementById("dealTypeGroup").addEventListener("change", ()=>{
      // ìƒë‹´ ìœ í˜• ë°”ë€Œë©´ ëª¨ë¸ ëª©ë¡ ë‹¤ì‹œ
      rebuildModelSelect(document.getElementById("carSearch").value.trim());
      // ì„ íƒ ì´ˆê¸°í™”
      selectedModel = null;
      selectedTrim = null;
      selectedOptions = [];
      document.getElementById("modelSelect").value = "";
      document.getElementById("trimSelect").innerHTML = `<option value="">ì°¨ëŸ‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>`;
      document.getElementById("trimSelect").disabled = true;
      document.getElementById("optionList").innerHTML = "";
      calcPrice();
      validate();
    });

    ["deliveryRegion","needWhen","applicantName","phone","kakaoId","agree"].forEach(id=>{
      document.getElementById(id).addEventListener("input", validate);
      document.getElementById(id).addEventListener("change", validate);
    });

    document.getElementById("submitBtn").addEventListener("click", submit);

    // ì‹œì‘
    loadCatalog().catch(()=> setToast("Catalog URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.", false));
  </script>
</body>
</html>
