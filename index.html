<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ë¹„ëŒ€ë©´ ì°¨ëŸ‰ ê²¬ì  ìƒë‹´</title>

  <style>
    :root{
      --text:#1f2328;
      --muted:rgba(31,35,40,.62);
      --stroke:rgba(17,17,17,.10);
      --card:rgba(255,255,255,.82);
      --card-strong:rgba(255,255,255,.90);
      --shadow: 0 18px 55px rgba(0,0,0,.12);
      --softshadow: 0 10px 30px rgba(0,0,0,.10);
      --radius: 26px;
      --radius2: 22px;
      --field: rgba(255,255,255,.92);
      --field2: rgba(255,255,255,.78);
      --primary1: #ff7fbf;
      --primary2: #b07cff;
      --primary3: #ff5da7;
      --danger:#e11d48;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo","Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
    
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }

    /* âœ… ì „ì²´ í˜ì´ì§€ í•‘í¬ ë² ì´ìŠ¤ ê·¸ë¼ (ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ì˜…ì–´ì§) */
    .page-bg{
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;

  background:
    radial-gradient(1100px 680px at 50% 10%,
      rgba(255, 120, 190, .22) 0%,
      rgba(255, 190, 225, .14) 45%,
      rgba(255, 255, 255, 0) 78%
    ),
    linear-gradient(to bottom,
      rgba(255, 170, 220, .30) 0%,
      rgba(255, 215, 240, .18) 40%,
      rgba(255, 245, 252, .10) 72%,
      rgba(255, 255, 255, 1) 100%
    );
    }

    /* âœ… ìƒë‹¨ ë°°ê²½ ì´ë¯¸ì§€: í™”ë©´ ë„ˆë¹„ ë”± ë§ê²Œ + ì•„ë˜ë¡œ íˆ¬ëª… ê·¸ë¼(í•‘í¬ ë² ì´ìŠ¤ì™€ ìì—° ì—°ê²°) */
    .hero{
      position:relative;
      z-index:1;
      width:100%;
      height:min(48vh, 220px);
      min-height: 220px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 22px 16px 16px;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        url("./bg.png") center / cover no-repeat;
      filter:saturate(1.03) contrast(1.02);
      transform: translateZ(0);
    }
    /* ì´ë¯¸ì§€ ì•„ë˜ìª½ì´ ì ì  íˆ¬ëª…í•´ì§€ë©° í•‘í¬ ë² ì´ìŠ¤ë¡œ ì—°ê²° */
    .hero::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;

  
    }

    /* âœ… íƒ€ì´í‹€: ë°°ê²½ ìœ„ì— ë°”ë¡œ ì˜¬ë¼ê°€ê²Œ(ë³„ë„ divë¡œ ê°ì‹¸ì§€ ì•ŠìŒ) */
    .hero-title{
      position:relative;
      z-index:2;
      text-align:center;
      color: rgba(15,15,18,.90);
      width:min(980px, 100%);
      padding: 0 10px 6px;
    }
    .hero-title h1{
      margin:30px;
      font-weight: 900;
      letter-spacing: -1px;
      font-size: clamp(22px, 5.2vw, 34px);
      text-shadow: 0 2px 18px rgba(255,255,255,.55);
    }
    .hero-title p{
      margin:10px 0 0;
      font-weight: 800;
      letter-spacing: -.3px;
      color: rgba(20,20,24,.62);
      font-size: clamp(13px, 3.6vw, 16px);
      text-shadow: 0 2px 14px rgba(255,255,255,.50);
    }

    .wrap{
      position:relative;
      z-index:2;
      width:min(980px, 100%);
      margin: -18px auto 32px;
      padding: 0 16px 24px;
    }

    /* âœ… í° ì¹´ë“œ(ëª©ì—… ëŠë‚Œ) */
    .shell{
      border-radius: calc(var(--radius) + 6px);
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.28);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .content{
      padding: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.45);
      border-radius: var(--radius);
      box-shadow: var(--softshadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .card + .card{ margin-top: 14px; }

    .card-inner{ padding: 18px; }

    .sec-title{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 0 0 14px;
      font-weight: 900;
      letter-spacing: -0.6px;
      font-size: 18px;
    }
    .badge{
      margin-left: 6px;
      font-size: 12px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      color: rgba(140, 20, 95, .92);
      background: rgba(255, 120, 190, .14);
      border: 1px solid rgba(255, 120, 190, .18);
      white-space:nowrap;
    }

    label{
      display:block;
      font-weight: 850;
      margin-top: 12px;
      letter-spacing: -.2px;
    }
    .help{
      margin: 8px 0 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }

    input, select{
      width:100%;
      margin-top: 8px;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.10);
      background: var(--field);
      outline: none;
      font-size: 15px;
      font-weight: 800;
      color: rgba(18,18,22,.92);
      box-shadow: 0 1px 0 rgba(255,255,255,.65) inset;
    }
    input::placeholder{ color: rgba(0,0,0,.34); font-weight: 800; }
    select:disabled, input:disabled{
      opacity: .55;
      background: rgba(245,245,246,.85);
    }
    input:focus, select:focus{
      border-color: rgba(255, 95, 170, .42);
      box-shadow: 0 0 0 4px rgba(255, 120, 190, .12);
    }

    .radio-row{
      display:flex;
      gap:6px;
      margin-top: 10px;
      flex-wrap: nowrap;
      font-size: 7pt;
    }
    .radio-pill{
      flex: 1 1 auto;
      min-width: 50px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding: 8px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.92);
      font-weight: 700;
      letter-spacing: -.2px;
      cursor:pointer;
      user-select:none;
    }
    .radio-pill input{
      width:18px;
      height:18px;
      margin:0;
      padding:0;
      border-radius:999px;
      box-shadow:none;
    }

    /* âœ… ê°œì¸ì •ë³´ìˆ˜ì§‘: ì²´í¬ë°•ìŠ¤-í…ìŠ¤íŠ¸ ë¶™ì´ê¸° */
    .consent{
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
    }
    .consent-row{
      display:flex;
      align-items:flex-start;
      gap:10px;            /* âœ… ê±°ë¦¬ ì¢í˜ */
      cursor:pointer;
      user-select:none;
    }
    .consent-row input{
      width:20px;
      height:20px;
      margin: 2px 0 0;     /* âœ… í…ìŠ¤íŠ¸ì™€ ìˆ˜í‰ ë§ì¶¤ */
      padding:0;
      box-shadow:none;
    }
    .consent strong{
      display:block;
      font-weight: 950;
      letter-spacing: -.3px;
      margin-bottom: 6px;
    }
    .consent small{
      display:block;
      color: var(--muted);
      font-weight: 750;
      line-height: 1.35;
    }

    /* âœ… ë²„íŠ¼: ëˆˆì— ë„ì§€ë§Œ ë‹¨ì •í•œ ê·¸ë¼ */
    .cta{
      margin-top: 14px;
      padding: 18px 16px 20px;
      text-align:center;
    }
    .btn{
  width:100%;
  border:0;
  border-radius:999px;
  padding:18px 18px;
  font-size:18px;
  font-weight:950;
  letter-spacing:-0.4px;
  color:#fff;
  cursor:pointer;

  background: linear-gradient(
    135deg,
    #ff3d9a 10%,     /* ğŸ”¥ ì„ ëª…í•œ í•«í•‘í¬ */
    #ff5fb3 50%,
    #c77dff 80%,
    #9b5cff 100%   /* ğŸ”¥ ë”¥ í¼í”Œ */
  );

  box-shadow:
    0 18px 40px rgba(255, 61, 154, .35),
    0 12px 30px rgba(155, 92, 255, .35);

  position:relative;
  overflow:hidden;
}
    .btn::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(600px 120px at 30% 0%,
          rgba(255,255,255,.35) 0%,
          rgba(255,255,255,0) 60%
        );
      opacity:.65;
      pointer-events:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{
      cursor:not-allowed;
      opacity:.45;
      box-shadow:none;
    }

    .footer-note{
      margin-top: 10px;
      color: rgba(0,0,0,.42);
      font-weight: 800;
      font-size: 13px;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(20,20,22,.86);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: .18s ease;
      z-index: 50;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }

    /* ì‘ì€ í™”ë©´ì—ì„œ ì—¬ë°±ë§Œ ì˜ˆì˜ê²Œ */
    @media (max-width: 420px){
      .content{ padding: 12px; }
      .card-inner{ padding: 16px; }
    }
  </style>
</head>

<body>
  <div class="page-bg" aria-hidden="true"></div>

  <header class="hero">
    <div class="hero-title">
      <h1>ë ŒíŠ¸/ë¦¬ìŠ¤ ê²¬ì  ì‹ ì²­</h1>
    </div>
  </header>

  <main class="wrap">


        <!-- âœ… íŒŒíŠ¸ 1: ì°¨ëŸ‰ ì„ íƒ -->
        <div class="card">
          
          <div class="card-inner">
            <div class="sec-title">ìƒí’ˆ ìœ í˜• <span class="badge">í•„ìˆ˜</span></div>
<div class="radio-row" role="radiogroup" aria-label="ìƒí’ˆ ìœ í˜•">
  <label class="radio-pill">
    <input type="radio" name="productType" value="ë ŒíŠ¸" checked />
    ë ŒíŠ¸
  </label>
  <label class="radio-pill">
    <input type="radio" name="productType" value="ë¦¬ìŠ¤" />
    ë¦¬ìŠ¤
  </label>
</div> </div>
          </div>
          <div class="card">
            <div class="card-inner">
            <div class="sec-title">ì°¨ëŸ‰ ì„ íƒ <span class="badge">í•„ìˆ˜</span></div>

            <label for="maker">ì œì¡°ì‚¬</label>
            <select id="maker">
              <option value="">ì œì¡°ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            </select>

            <label for="modelInput">ì°¨ì¢…</label>
<input id="modelInput" list="modelList" placeholder="ì°¨ì¢…ì„ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•´ìš”" disabled />
<datalist id="modelList"></datalist>

            <label for="grade">ì°¨ëŸ‰ ë“±ê¸‰</label>
            <select id="grade" disabled>
              <option value="">ì°¨ëŸ‰ ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            </select>

            <label for="options">ì˜µì…˜</label>
            <select id="options" disabled>
              <option value="">ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            </select>

            <p class="help">â€» ì œì¡°ì‚¬ â†’ ì°¨ì¢… â†’ ë“±ê¸‰ â†’ ì˜µì…˜ ìˆœì„œë¡œ ì„ íƒë©ë‹ˆë‹¤.</p>
          </div>
        </div></div>

        <!-- âœ… íŒŒíŠ¸ 2: ì‹ ì²­ ì •ë³´ -->
        <div class="card">
          <div class="card-inner">
            <div class="sec-title">ì‹ ì²­ ì •ë³´ <span class="badge">í•„ìˆ˜</span></div>

            <label>ê³ ê° ìœ í˜•</label>
            <div class="radio-row" role="radiogroup" aria-label="ê³ ê° ìœ í˜•">
              <label class="radio-pill">
                <input type="radio" name="customerType" value="ê°œì¸" checked />
                ê°œì¸
              </label>
              <label class="radio-pill">
                <input type="radio" name="customerType" value="ê°œì¸ì‚¬ì—…ì" />
                ê°œì¸ì‚¬ì—…ì
              </label>
              <label class="radio-pill">
                <input type="radio" name="customerType" value="ë²•ì¸" />
                ë²•ì¸
              </label>
            </div>

            <label for="name">ì„±ëª…</label>
            <input id="name" placeholder="ì˜ˆ) í™ê¸¸ë™" autocomplete="name" />

            <label for="phone">ì—°ë½ì²˜</label>
            <input id="phone" placeholder="ì˜ˆ) 010-1234-5678" inputmode="tel" autocomplete="tel" />

            <label for="deliveryTime">ì°¨ëŸ‰ ì¸ë„ ì‹œê¸°</label>
            <input id="deliveryTime" placeholder="ì˜ˆ) ê°€ëŠ¥í•œ ë¹¨ë¦¬ / 2ì›” ì¤‘ìˆœ / ë¯¸ì •" />
            
            <label for="deliveryArea">ì°¨ëŸ‰ ì¸ë„ ì§€ì—­</label>
<input id="deliveryArea" placeholder="ì˜ˆ) ì„œìš¸ / ê²½ê¸° ë‚¨ì–‘ì£¼" />

            <label for="kakao">ì¹´ì¹´ì˜¤í†¡ ì•„ì´ë”” (ì„ íƒ)</label>
            <input id="kakao" placeholder="ì˜ˆ) melody7017" autocomplete="off" />

            <div class="consent">
              <label class="consent-row" for="agree">
                <input id="agree" type="checkbox" />
                <div>
                  <strong>[í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</strong>
                  <small>
                    ìˆ˜ì§‘: ì„±ëª…, ì—°ë½ì²˜, ì¹´ì¹´ì˜¤í†¡ ID(ì„ íƒ), ì°¨ëŸ‰ ì„ íƒ ì •ë³´ / ëª©ì : ê²¬ì Â·ìƒë‹´ ì•ˆë‚´ /
                    ë³´ìœ : ìƒë‹´ ì™„ë£Œ í›„ 1ë…„
                  </small>
                </div>
              </label>
            </div>

            <div class="cta">
              <button id="submitBtn" class="btn" disabled>ê°„ë‹¨ ê²¬ì  ìš”ì²­í•˜ê¸°</button>
              <div class="footer-note">ë¬¸ì ë˜ëŠ” ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì•ˆë‚´ ë“œë¦½ë‹ˆë‹¤.<br>
                ë¬¸ìëŠ” ì‘ëŒ€ê°€ ì§€ì—°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

      </div>
 
 
    
  </main>

  <div id="toast" class="toast" aria-live="polite"></div>

  <script>
/***************************************************************
 * âœ… ì„¤ì •: Apps Script Web App URL
 ***************************************************************/
const API_BASE = "https://script.google.com/macros/s/AKfycbxpYN2m_14RHMJtHgSHj4t315mLlNJYJti9tZniR0iyb4-WuqeR9dc0GSFwjM_NG7m8-Q/exec";

/***************************************************************
 * âœ… DOM (HTML idì™€ 1:1ë¡œ ë§ì¶¤)
 ***************************************************************/
const elMaker       = document.getElementById("maker");
const elModelInput  = document.getElementById("modelInput");     // âœ… input
const elModelList   = document.getElementById("modelList");      // âœ… datalist
const elGrade       = document.getElementById("grade");
const elOptions     = document.getElementById("options");

const elName        = document.getElementById("name");
const elPhone       = document.getElementById("phone");
const elDelivery    = document.getElementById("deliveryTime");
const elRegion      = document.getElementById("deliveryArea"); // âœ… ì§€ì—­
const elKakao       = document.getElementById("kakao");
const elAgree       = document.getElementById("agree");
const elSubmit      = document.getElementById("submitBtn");
const elToast       = document.getElementById("toast");

/***************************************************************
 * âœ… ìƒíƒœ
 ***************************************************************/
let catalogRows = []; // {maker, model, grade, option}
let makers = [];
let modelsByMaker = new Map();         // maker -> [model...]
let gradesByMakerModel = new Map();    // maker||model -> [grade...]
let optionsByTriple = new Map();       // maker||model||grade -> [option...]

/***************************************************************
 * âœ… ìœ í‹¸
 ***************************************************************/
function toast(msg){
  if (!elToast) { alert(msg); return; }
  elToast.textContent = msg;
  elToast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> elToast.classList.remove("show"), 1700);
}

function norm(s){ return (s ?? "").toString().trim(); }
function key2(a,b){ return `${a}||${b}`; }
function key3(a,b,c){ return `${a}||${b}||${c}`; }

function setSelectOptions(select, items, placeholder){
  if (!select) return;
  select.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  select.appendChild(opt0);

  for (const it of items){
    const o = document.createElement("option");
    o.value = it;
    o.textContent = it;
    select.appendChild(o);
  }
}

function resetSelect(select, placeholder){
  if (!select) return;
  select.disabled = true;
  setSelectOptions(select, [], placeholder);
}
function enableSelect(select){
  if (!select) return;
  select.disabled = false;
}

function setDatalistOptions(datalist, items){
  if (!datalist) return;
  datalist.innerHTML = "";
  const frag = document.createDocumentFragment();
  for (const it of items){
    const opt = document.createElement("option");
    opt.value = it;
    frag.appendChild(opt);
  }
  datalist.appendChild(frag);
}

function resetModelInput(){
  if (!elModelInput) return;
  elModelInput.value = "";
  elModelInput.disabled = true;
  elModelInput.readOnly = true;   // âœ… ëª¨ë°”ì¼ì—ì„œ í‚¤ë³´ë“œ ê°•ì œ ë°©ì§€ í•´ì œìš©(ì´ˆê¸°ì—” ì ê¸ˆ)
  setDatalistOptions(elModelList, []);
}

function enableModelInput(){
  if (!elModelInput) return;
  elModelInput.disabled = false;
  elModelInput.readOnly = false;  // âœ… íƒ€ì´í•‘ ê°€ëŠ¥
  elModelInput.blur();            // âœ… iOS/ì•ˆë“œë¡œì´ë“œì—ì„œ ìƒíƒœ ê°±ì‹  ê¼¬ì„ ë°©ì§€
}

function phoneFormatLoose(v){
  const d = v.replace(/[^\d]/g,"").slice(0,11);
  if (d.length <= 3) return d;
  if (d.length <= 7) return `${d.slice(0,3)}-${d.slice(3)}`;
  return `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`;
}

function getCheckedValue(name, fallback){
  const r = document.querySelector(`input[name="${name}"]:checked`);
  return r ? r.value : fallback;
}
function getCustomerType(){ return getCheckedValue("customerType", "ê°œì¸"); }
function getProductType(){ return getCheckedValue("productType", "ë ŒíŠ¸"); }

/**
 * âœ… ì„œë²„ê°€ JSON ì•„ë‹Œ ê±¸ ì£¼ë©´(ì˜¤ë¥˜ HTML ë“±) ì›ë¬¸ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•œ í•¨ìˆ˜
 */
async function fetchJsonStrict(url, options){
  const res = await fetch(url, options);
  const text = await res.text();
  try{
    return { ok: res.ok, json: JSON.parse(text), status: res.status, raw: text };
  }catch(e){
    return { ok: false, json: null, status: res.status, raw: text, parseError: e };
  }
}

/***************************************************************
 * âœ… ê²€ì¦
 * - ì˜µì…˜ì€ í•„ìˆ˜ ì•„ë‹˜ (ë¹ˆê°’ì´ë©´ 'ì˜µì…˜ ì—†ìŒ'ìœ¼ë¡œ ì €ì¥)
 * - ì§€ì—­ì€ "ë°›ì•„ì•¼ í•œë‹¤" í–ˆìœ¼ë‹ˆ ì—¬ê¸°ì„œëŠ” í•„ìˆ˜ë¡œ ì²˜ë¦¬í•´ë‘ 
 ***************************************************************/
function validate(){
  const ok =
    norm(elMaker?.value) &&
    norm(elModelInput?.value) &&
    norm(elGrade?.value) &&
    norm(elName?.value) &&
    norm(elPhone?.value) &&
    norm(elDelivery?.value) &&
    norm(elRegion?.value) &&     // âœ… ì§€ì—­ í•„ìˆ˜
    !!elAgree?.checked;

  if (elSubmit) elSubmit.disabled = !ok;
  return !!ok;
}

/***************************************************************
 * âœ… ì¹´íƒˆë¡œê·¸ ë¡œë“œ + ì¸ë±ìŠ¤ ë¹Œë“œ
 * ê¸°ëŒ€ í–‰ í•„ë“œ: maker/model/grade/option (ë˜ëŠ” í•œê¸€ í—¤ë”)
 ***************************************************************/
async function fetchCatalog(){
  const url = `${API_BASE}?action=catalog&_=${Date.now()}`;

  let r;
  try{
    r = await fetchJsonStrict(url, { method:"GET", cache:"no-store" });
  }catch(e){
    console.error(e);
    toast("ì¹´íƒˆë¡œê·¸ í˜¸ì¶œ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ)");
    return;
  }

  if (!r.json){
    console.error("Catalog raw:", r.raw);
    toast("ì¹´íƒˆë¡œê·¸ ì‘ë‹µì´ JSONì´ ì•„ë‹˜. (ì›¹ì•± ë°°í¬/ê¶Œí•œ/ì‘ë‹µ í™•ì¸)");
    alert((r.raw || "").slice(0, 700));
    return;
  }

  const data = r.json;
  const rows = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? []);
  if (!Array.isArray(rows) || rows.length === 0){
    console.warn("catalog payload:", data);
    toast("ì¹´íƒˆë¡œê·¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´ìš”. (Models ì‹œíŠ¸/ë°ì´í„°/ê¶Œí•œ í™•ì¸)");
    alert(JSON.stringify(data).slice(0, 700));
    return;
  }

  // í—¤ë” ë°©ì–´: ì˜ì–´/í•œê¸€ ë‘˜ ë‹¤ ë°›ê¸°
  catalogRows = rows.map(x => ({
    maker:  norm(x.maker ?? x.ì œì¡°ì‚¬ ?? x.ì œì¡°ì‚¬ëª… ?? x.Maker),
    model:  norm(x.model ?? x.ì°¨ì¢… ?? x.ëª¨ë¸ ?? x.Model),
    grade:  norm(x.grade ?? x.ë“±ê¸‰ ?? x.íŠ¸ë¦¼ ?? x.Trim ?? x.ì°¨ëŸ‰ë“±ê¸‰),
    option: norm(x.option ?? x.ì˜µì…˜ ?? x.Options ?? x.Option),
    raw: x
  })).filter(r => r.maker && r.model && r.grade);

  if (catalogRows.length === 0){
    toast("í•„ìˆ˜ ì»¬ëŸ¼(ì œì¡°ì‚¬/ì°¨ì¢…/ë“±ê¸‰) ë§¤í•‘ì´ ì•ˆ ëì–´ìš”. í—¤ë” í™•ì¸!");
    return;
  }

  buildIndexes();
  hydrateMaker();
  toast("ì°¨ëŸ‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ì–´ìš”.");
}

function buildIndexes(){
  makers = [];
  modelsByMaker.clear();
  gradesByMakerModel.clear();
  optionsByTriple.clear();

  const makerSet = new Set();

  for (const r of catalogRows){
    makerSet.add(r.maker);

    if (!modelsByMaker.has(r.maker)) modelsByMaker.set(r.maker, new Set());
    modelsByMaker.get(r.maker).add(r.model);

    const k2 = key2(r.maker, r.model);
    if (!gradesByMakerModel.has(k2)) gradesByMakerModel.set(k2, new Set());
    gradesByMakerModel.get(k2).add(r.grade);

    const k3 = key3(r.maker, r.model, r.grade);
    if (!optionsByTriple.has(k3)) optionsByTriple.set(k3, new Set());
    if (r.option) optionsByTriple.get(k3).add(r.option);
  }

  makers = [...makerSet].sort((a,b)=>a.localeCompare(b,"ko"));

  for (const [m, set] of modelsByMaker){
    modelsByMaker.set(m, [...set].sort((a,b)=>a.localeCompare(b,"ko")));
  }
  for (const [k, set] of gradesByMakerModel){
    gradesByMakerModel.set(k, [...set].sort((a,b)=>a.localeCompare(b,"ko")));
  }
  for (const [k, set] of optionsByTriple){
    optionsByTriple.set(k, [...set].sort((a,b)=>a.localeCompare(b,"ko")));
  }
}

function hydrateMaker(){
  setSelectOptions(elMaker, makers, "ì œì¡°ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”");

  // downstream reset
  resetModelInput();
  resetSelect(elGrade, "ì°¨ëŸ‰ ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”");

  // ì˜µì…˜ì€ í•­ìƒ ì„ íƒ ê°€ëŠ¥ + ê¸°ë³¸ 'ì˜µì…˜ ì—†ìŒ'
  setSelectOptions(elOptions, ["ì˜µì…˜ ì—†ìŒ"], "ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
  enableSelect(elOptions);
  elOptions.value = "ì˜µì…˜ ì—†ìŒ";

  validate();
}

/***************************************************************
 * âœ… ì²´ì¸: maker -> modelInput(datalist) -> grade -> options(ì„ íƒ)
 ***************************************************************/
elMaker?.addEventListener("change", ()=>{
  const maker = norm(elMaker.value);

  resetModelInput();
  resetSelect(elGrade, "ì°¨ëŸ‰ ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”");

  // ì˜µì…˜ ê¸°ë³¸
  setSelectOptions(elOptions, ["ì˜µì…˜ ì—†ìŒ"], "ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
  enableSelect(elOptions);
  elOptions.value = "ì˜µì…˜ ì—†ìŒ";

  if (!maker){ validate(); return; }

  const models = modelsByMaker.get(maker) ?? [];
  setDatalistOptions(elModelList, models);
  enableModelInput();
  validate();
});

// ì°¨ì¢… ì…ë ¥/ì„ íƒ ì‹œ ë“±ê¸‰ ì±„ì›€
function onModelPicked(){
  const maker = norm(elMaker.value);
  const model = norm(elModelInput.value);

  resetSelect(elGrade, "ì°¨ëŸ‰ ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”");

  // ì˜µì…˜ ê¸°ë³¸
  setSelectOptions(elOptions, ["ì˜µì…˜ ì—†ìŒ"], "ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
  enableSelect(elOptions);
  elOptions.value = "ì˜µì…˜ ì—†ìŒ";

  if (!maker || !model){ validate(); return; }

  // âœ… datalist ëª©ë¡ì— ì—†ëŠ” ê°’ì„ íƒ€ì´í•‘í•œ ê²½ìš° ë§‰ê¸°(ì›í•˜ë©´ ì´ ì²´í¬ ì œê±° ê°€ëŠ¥)
  const allowed = (modelsByMaker.get(maker) ?? []).includes(model);
  if (!allowed){
    toast("ëª©ë¡ì—ì„œ ì°¨ì¢…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    elModelInput.value = "";
    validate();
    return;
  }

  const grades = gradesByMakerModel.get(key2(maker, model)) ?? [];
  if (grades.length === 0){
    toast("í•´ë‹¹ ì°¨ì¢…ì˜ ë“±ê¸‰ì´ ì—†ì–´ìš”. (Models ë°ì´í„° í™•ì¸)");
    validate();
    return;
  }

  setSelectOptions(elGrade, grades, "ì°¨ëŸ‰ ë“±ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
  enableSelect(elGrade);
  validate();
}

// ëª¨ë°”ì¼/ë¸Œë¼ìš°ì €ë§ˆë‹¤ datalist ì„ íƒ ì´ë²¤íŠ¸ê°€ ë‹¬ë¼ì„œ input+change ë‘˜ ë‹¤ ì²˜ë¦¬
elModelInput?.addEventListener("input", onModelPicked);
elModelInput?.addEventListener("change", onModelPicked);

elGrade?.addEventListener("change", ()=>{
  const maker = norm(elMaker.value);
  const model = norm(elModelInput.value);
  const grade = norm(elGrade.value);

  // ì˜µì…˜ì€ ì„ íƒ: ìˆìœ¼ë©´ ë³´ì—¬ì£¼ê³  ì—†ìœ¼ë©´ 'ì˜µì…˜ ì—†ìŒ'ë§Œ
  const opts = (maker && model && grade)
    ? (optionsByTriple.get(key3(maker, model, grade)) ?? [])
    : [];

  const list = opts.length ? ["ì˜µì…˜ ì—†ìŒ", ...opts] : ["ì˜µì…˜ ì—†ìŒ"];
  setSelectOptions(elOptions, list, "ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
  enableSelect(elOptions);
  elOptions.value = "ì˜µì…˜ ì—†ìŒ";

  validate();
});

elOptions?.addEventListener("change", validate);
elAgree?.addEventListener("change", validate);

elName?.addEventListener("input", validate);
elDelivery?.addEventListener("input", validate);
elRegion?.addEventListener("input", validate);
elKakao?.addEventListener("input", validate);

elPhone?.addEventListener("input", (e)=>{
  e.target.value = phoneFormatLoose(e.target.value);
  validate();
});

// ë¼ë””ì˜¤ ë³€ê²½ ì‹œ ê²€ì¦ë§Œ ê°±ì‹ 
document.querySelectorAll('input[name="productType"], input[name="customerType"]')
  .forEach(el => el.addEventListener("change", validate));

/***************************************************************
 * âœ… ì œì¶œ
 ***************************************************************/
async function submitApplication(){
  if (!validate()){
    toast("í•„ìˆ˜ í•­ëª©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    return;
  }

  elSubmit.disabled = true;
  elSubmit.textContent = "ì „ì†¡ ì¤‘â€¦";

  const payload = {
    action: "apply",
    productType: getProductType(),            // ë ŒíŠ¸/ë¦¬ìŠ¤
    maker: norm(elMaker.value),
    model: norm(elModelInput.value),          // âœ… input
    grade: norm(elGrade.value),
    option: norm(elOptions.value) || "ì˜µì…˜ ì—†ìŒ", // âœ… ì˜µì…˜ ì„ íƒ ì•„ë‹˜
    customerType: getCustomerType(),
    name: norm(elName.value),
    phone: norm(elPhone.value),
    deliveryTime: norm(elDelivery.value),
    deliveryArea: norm(elRegion.value),     // âœ… ì§€ì—­
    kakaoId: norm(elKakao.value),
    agreed: true,
    source: "github-pages",
    ts: new Date().toISOString()
  };

  let ok = false;
  let message = "ì ‘ìˆ˜ ì™„ë£Œ! ê³§ ì•ˆë‚´ë“œë¦´ê²Œìš”.";

  // 1) POST(JSON)
  try{
    const r = await fetchJsonStrict(`${API_BASE}?action=apply`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if (r.json && (r.json.ok !== false)){
      ok = true;
      if (r.json.message) message = r.json.message;
    }else{
      throw new Error("POST failed / non-json");
    }
  }catch(e){
    // 2) GET fallback
    try{
      const qs = new URLSearchParams(payload).toString();
      const r2 = await fetchJsonStrict(`${API_BASE}?${qs}`, { method:"GET", cache:"no-store" });

      if (r2.json && (r2.json.ok !== false)){
        ok = true;
        if (r2.json.message) message = r2.json.message;
      }else{
        throw new Error("GET failed / non-json");
      }
    }catch(e2){
      console.error(e2);
    }
  }

  if (ok){
    toast(message);

    // ê°œì¸ì •ë³´ë§Œ ë¦¬ì…‹
    elName.value = "";
    elPhone.value = "";
    elDelivery.value = "";
    elRegion.value = "";
    elKakao.value = "";
    elAgree.checked = false;

    // ê¸°ë³¸ ë¼ë””ì˜¤
    const ct = document.querySelector('input[name="customerType"][value="ê°œì¸"]');
    if (ct) ct.checked = true;
    const pt = document.querySelector('input[name="productType"][value="ë ŒíŠ¸"]');
    if (pt) pt.checked = true;

    // ì˜µì…˜ ê¸°ë³¸ê°’
    if (elOptions && [...elOptions.options].some(o => o.value === "ì˜µì…˜ ì—†ìŒ")){
      elOptions.value = "ì˜µì…˜ ì—†ìŒ";
    }
  }else{
    toast("ì „ì†¡ ì‹¤íŒ¨. ì›¹ì•± ì‘ë‹µ(JSON)/ê¶Œí•œ/ë°°í¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }

  elSubmit.textContent = "ê°„ë‹¨ ê²¬ì  ìš”ì²­í•˜ê¸°";
  validate();
}

elSubmit?.addEventListener("click", submitApplication);

/***************************************************************
 * âœ… ì‹œì‘
 ***************************************************************/
(function init(){
  validate();
  fetchCatalog();
})();
</script>
</body>
</html>
