<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비대면 자동차 견적 시스템</title>
    <style>
        :root { --primary: #1a73e8; --bg-overlay: rgba(0, 0, 0, 0.75); }
        body {
            margin: 0; font-family: 'Pretendard', -apple-system, sans-serif;
            background: url('bg.png') no-repeat center center fixed; background-size: cover;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .container {
            background: var(--bg-overlay); color: white; padding: 25px; border-radius: 12px;
            width: 95%; max-width: 450px; backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h2 { text-align: center; font-weight: 600; margin-bottom: 20px; font-size: 1.4rem; }
        .section-title { font-size: 0.85rem; color: #aaa; margin-bottom: 8px; margin-top: 15px; }
        
        /* 입력 요소 스타일 */
        select, input[type="text"], input[type="tel"] {
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444;
            background: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box; font-size: 1rem; margin-bottom: 10px;
        }
        select option { background: #333; color: white; }
        
        /* 라디오 버튼 그룹 (렌트/리스) */
        .radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .radio-group label {
            flex: 1; text-align: center; padding: 10px; border: 1px solid #555; border-radius: 6px; cursor: pointer; transition: 0.3s;
        }
        .radio-group input { display: none; }
        .radio-group input:checked + label { background: var(--primary); border-color: var(--primary); }

        /* 옵션 리스트 */
        .option-container {
            background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 6px; 
            max-height: 140px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #444;
        }
        .option-item { display: flex; align-items: center; font-size: 0.9rem; margin-bottom: 6px; cursor: pointer; }
        .option-item input { margin-right: 10px; }

        .price-box {
            background: rgba(26, 115, 232, 0.2); padding: 15px; border-radius: 6px;
            text-align: right; margin-top: 15px; border: 1px solid var(--primary);
        }
        .price-box span { font-size: 1.3rem; font-weight: bold; color: #52ff52; }

        .consent { font-size: 0.75rem; color: #bbb; display: flex; align-items: flex-start; gap: 8px; margin-top: 15px; }
        button {
            width: 100%; padding: 16px; background: var(--primary); color: white; border: none;
            border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 15px;
        }
        button:hover { background: #1557b0; }
        button:disabled { background: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>렌트/리스 비대면 견적</h2>
    <form id="quoteForm">
        <div class="radio-group">
            <input type="radio" id="rent" name="dealType" value="rent" checked>
            <label for="rent">장기렌트</label>
            <input type="radio" id="lease" name="dealType" value="lease">
            <label for="lease">리스</label>
        </div>

        <div class="section-title">차량 정보</div>
        <select id="makerSelect" required><option value="">제조사 선택</option></select>
        <select id="modelSelect" required disabled><option value="">모델 선택</option></select>
        <select id="trimSelect" required disabled><option value="">트림 선택</option></select>

        <div class="section-title">추가 옵션</div>
        <div id="optionList" class="option-container">
            <div style="color:#777; font-size:0.8rem; text-align:center; padding-top:40px;">트림을 먼저 선택해 주세요</div>
        </div>

        <div class="price-box">
            최종 견적가: <span id="totalPrice">0</span>원
        </div>

        <div class="section-title">고객 정보</div>
        <input type="text" id="userName" placeholder="성함" required>
        <input type="tel" id="userPhone" placeholder="휴대폰 번호 (숫자만)" required>
        <input type="text" id="kakaoId" placeholder="카카오톡 ID (선택)">

        <div class="consent">
            <input type="checkbox" id="consent" required>
            <label for="consent">개인정보 수집 및 제3자 제공에 동의합니다. (견적 상담 목적)</label>
        </div>

        <button type="submit" id="submitBtn">실시간 견적 신청하기</button>
    </form>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxE58tNJ_Nfr5KNFMp0b6P4dWyBGnP_CPDiTuontpL1u4b931Tx6EWn5iCR9CqjEzne/exec';
    let rawData = [];
    let currentBasePrice = 0;

    // 데이터 로드
    async function init() {
        try {
            const res = await fetch(`${API_URL}?action=catalog`);
            rawData = await res.json();
            
            const makers = [...new Set(rawData.map(d => d.maker))];
            const makerSelect = document.getElementById('makerSelect');
            makers.forEach(m => makerSelect.add(new Option(m, m)));
        } catch (e) { alert("데이터 로딩 실패"); }
    }

    // 제조사 변경 시
    document.getElementById('makerSelect').onchange = (e) => {
        const models = [...new Set(rawData.filter(d => d.maker === e.target.value).map(d => d.model))];
        updateSelect('modelSelect', models, "모델 선택");
        resetBelow('model');
    };

    // 모델 변경 시
    document.getElementById('modelSelect').onchange = (e) => {
        const maker = document.getElementById('makerSelect').value;
        const trims = [...new Set(rawData.filter(d => d.maker === maker && d.model === e.target.value).map(d => d.trim))];
        updateSelect('trimSelect', trims, "트림 선택");
        resetBelow('trim');
    };

    // 트림 변경 시 (가격 및 옵션 생성)
    document.getElementById('trimSelect').onchange = (e) => {
        const maker = document.getElementById('makerSelect').value;
        const model = document.getElementById('modelSelect').value;
        const filtered = rawData.filter(d => d.maker === maker && d.model === model && d.trim === e.target.value);
        
        if(filtered.length > 0) {
            currentBasePrice = filtered[0].basePrice;
            const optionList = document.getElementById('optionList');
            optionList.innerHTML = '';
            
            filtered.forEach(item => {
                if(item.optionName) {
                    const label = document.createElement('label');
                    label.className = 'option-item';
                    label.innerHTML = `<input type="checkbox" name="opts" value="${item.optionPrice}" data-name="${item.optionName}" onchange="calc()"> 
                                       ${item.optionName} (+${item.optionPrice.toLocaleString()}원)`;
                    optionList.appendChild(label);
                }
            });
            calc();
        }
    };

    function updateSelect(id, list, defaultText) {
        const el = document.getElementById(id);
        el.innerHTML = `<option value="">${defaultText}</option>`;
        list.forEach(v => el.add(new Option(v, v)));
        el.disabled = false;
    }

    function resetBelow(type) {
        if(type === 'model') { 
            document.getElementById('trimSelect').innerHTML = '<option value="">트림 선택</option>';
            document.getElementById('trimSelect').disabled = true;
        }
        document.getElementById('optionList').innerHTML = '<div style="color:#777; font-size:0.8rem; text-align:center; padding-top:40px;">트림을 선택해 주세요</div>';
        currentBasePrice = 0;
        calc();
    }

    function calc() {
        let optSum = 0;
        document.querySelectorAll('input[name="opts"]:checked').forEach(c => optSum += Number(c.value));
        document.getElementById('totalPrice').innerText = (currentBasePrice + optSum).toLocaleString();
    }

    // 폼 제출
    document.getElementById('quoteForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerText = "전송 중...";

        const selectedOpts = Array.from(document.querySelectorAll('input[name="opts"]:checked')).map(c => c.dataset.name).join(', ');
        const optPrice = Array.from(document.querySelectorAll('input[name="opts"]:checked')).reduce((a, b) => a + Number(b.value), 0);

        const params = new URLSearchParams({
            action: 'submit',
            dealType: document.querySelector('input[name="dealType"]:checked').value,
            maker: document.getElementById('makerSelect').value,
            model: document.getElementById('modelSelect').value,
            trim: document.getElementById('trimSelect').value,
            options: selectedOpts,
            basePrice: currentBasePrice,
            optionPrice: optPrice,
            totalPrice: currentBasePrice + optPrice,
            applicantName: document.getElementById('userName').value,
            phone: document.getElementById('userPhone').value,
            kakaoId: document.getElementById('kakaoId').value,
            submittedAt: new Date().toLocaleString()
        });

        try {
            await fetch(`${API_URL}?${params.toString()}`, { mode: 'no-cors' });
            alert("신청이 완료되었습니다. 곧 연락드리겠습니다!");
            location.reload();
        } catch(e) { 
            alert("전송 오류"); 
            btn.disabled = false; btn.innerText = "실시간 견적 신청하기";
        }
    };

    init();
</script>
</body>
</html>
