<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ë¹„ëŒ€ë©´ ì°¨ëŸ‰ ê²¬ì  ìƒë‹´</title>

  <style>
    :root{
      --text:#241c23;
      --muted: rgba(36,28,35,.62);

      /* í•‘í¬ ë² ì´ìŠ¤ (ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ì˜…ì–´ì§) */
      --base-top: rgba(255, 196, 224, .75);
      --base-mid: rgba(255, 220, 236, .45);
      --base-bot: rgba(255, 245, 251, .18);

      /* ê¸€ë˜ìŠ¤ ì¹´ë“œ */
      --card: rgba(255,255,255,.72);
      --stroke: rgba(255,255,255,.55);
      --shadow: 0 14px 45px rgba(0,0,0,.12);

      /* ë²„íŠ¼ ê·¸ë¼(ë‹¨ì •í•˜ì§€ë§Œ ëˆˆì— ë„ê²Œ) */
      --btn1: rgba(255, 104, 165, .95);
      --btn2: rgba(157, 132, 255, .92);
      --btn3: rgba(255, 168, 206, .90);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        linear-gradient(180deg, var(--base-top) 0%, var(--base-mid) 45%, var(--base-bot) 100%);
      overflow-x:hidden;
    }

    /* ===== ìƒë‹¨ ë°°ê²½(ì´ë¯¸ì§€ ë„ˆë¹„ ë”± ë§ê²Œ) =====
       - cover ê¸ˆì§€: width:100%, height:auto
       - ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ íˆ¬ëª…í•´ì§€ëŠ” í˜ì´ë“œ */
    .bg-stage{
      position:relative;
      width:100%;
      overflow:hidden;
    }
    .bg-stage img{
      display:block;
      width:100%;
      height:auto;              /* âœ… ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ */
      max-height: 420px;        /* ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì»· */
      object-fit: contain;      /* âœ… cover ì•„ë‹˜ */
      opacity:.82;              /* âœ… ë†ë„ ë‚®ì¶¤ */
      filter: saturate(1.05) contrast(1.02);
    }
    .bg-stage::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-1px;
      height:140px;
      /* âœ… ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ì˜…ì–´ì§€ê²Œ(=íˆ¬ëª…ìœ¼ë¡œ ì‚¬ë¼ì§) */
      background: linear-gradient(
        180deg,
        rgba(255,255,255,0) 0%,
        rgba(255, 220, 236, .35) 35%,
        rgba(255, 196, 224, .65) 100%
      );
      pointer-events:none;
    }

    /* ===== íƒ€ì´í‹€: ë°°ê²½ ìœ„ì— ë°”ë¡œ ===== */
    .hero{
      position:absolute;
      left:0; right:0;
      top: calc(18px + env(safe-area-inset-top));
      padding: 0 18px;
      text-align:center;
      pointer-events:none;
    }
    .hero h1{
      margin:0;
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.6px;
      color: rgba(24,16,22,.82);
      text-shadow: 0 2px 16px rgba(255,255,255,.6);
    }
    .hero p{
      margin:8px 0 0;
      font-size: 13px;
      font-weight: 800;
      color: rgba(24,16,22,.55);
      text-shadow: 0 2px 14px rgba(255,255,255,.65);
    }

    /* ===== ì „ì²´ ë ˆì´ì•„ì›ƒ ===== */
    .wrap{
      max-width: 420px;
      margin: -44px auto 48px;   /* bg ì•„ë˜ë¡œ ì¹´ë“œê°€ ì‚´ì§ ê²¹ì¹˜ê²Œ */
      padding: 0 14px;
    }

    /* ì¹´ë“œ(í¼ ì˜ì—­) */
    .sheet{
      background: rgba(255,255,255,.42);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .sheet-inner{
      padding: 14px;
    }

    /* ì„¹ì…˜ ì¹´ë“œ(ì°¨ëŸ‰ ì„ íƒ / ì¡°ê±´ / ì‹ ì²­ì ì •ë³´ ë“±) */
    .sec{
      background: var(--card);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .sec + .sec{ margin-top: 12px; }

    .sec-title{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 0 0 10px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing:-.3px;
    }

    .badge{
      font-size: 12px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 132, 189, .16);
      border: 1px solid rgba(255, 132, 189, .22);
      color: rgba(156, 50, 109, .95);
    }

    label{
      display:block;
      font-size: 13px;
      font-weight: 900;
      margin: 10px 0 6px;
    }
    .hint{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    input, select, textarea{
      width:100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.80);
      outline:none;
      font-size: 14px;
      font-weight: 700;
      color: rgba(24,16,22,.88);
    }
    input::placeholder, textarea::placeholder{ color: rgba(24,16,22,.35); font-weight:700; }
    textarea{ min-height: 86px; resize: vertical; }

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* ë¼ë””ì˜¤ ê·¸ë£¹ */
    .pillset{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.78);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .pill input{ width:auto; margin:0; }
    .pill input{ accent-color: rgba(236, 80, 155, .95); }

    /* ê°€ê²© ìš”ì•½ */
    .price3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .pricebox{
      background: rgba(255,255,255,.82);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 12px 10px;
      text-align:center;
    }
    .pricebox .k{ font-size: 12px; font-weight: 900; color: rgba(24,16,22,.55); }
    .pricebox .v{ margin-top:6px; font-size: 18px; font-weight: 1000; }

    /* ë™ì˜ */
    .agree{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.72);
      margin-top: 10px;
    }
    .agree input{ margin-top: 3px; accent-color: rgba(236, 80, 155, .95); }
    .agree b{ display:block; font-size: 13px; font-weight: 1000; }
    .agree small{ display:block; margin-top:6px; color: var(--muted); font-weight:700; line-height: 1.35; }

    /* ë²„íŠ¼: ë‹¨ì •í•œ ê·¸ë¼ + ê¸€ì ë˜ë · + ê·¸ë¦¼ì */
    .cta{
      margin-top: 12px;
      padding: 14px 10px 16px;
      text-align:center;
    }
    .btn{
      width: 100%;
      border:0;
      border-radius: 999px;
      padding: 16px 18px;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: -0.3px;
      color: white;
      background:
        linear-gradient(90deg, var(--btn1) 0%, var(--btn2) 55%, var(--btn3) 100%);
      box-shadow:
        0 14px 28px rgba(255, 88, 160, .22),
        0 10px 28px rgba(120, 90, 255, .18);
      cursor:pointer;
      transition: transform .08s ease, filter .18s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn:disabled{
      filter: grayscale(.35) opacity(.65);
      cursor:not-allowed;
      box-shadow:none;
    }
    .cta .sub{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 800;
      color: rgba(24,16,22,.55);
    }

    /* ë°ìŠ¤í¬íƒ‘ ì•½ê°„ë§Œ ì •ë ¬ */
    @media (min-width: 860px){
      .wrap{ max-width: 920px; margin-top: -66px; }
      .sheet-inner{ padding: 18px; }
      .grid2{
        display:grid;
        grid-template-columns: 1.05fr .95fr;
        gap: 12px;
        align-items:start;
      }
    }
  </style>
</head>

<body>

  <!-- âœ… ë°°ê²½ + íƒ€ì´í‹€(ë°°ê²½ ìœ„ì— ë°”ë¡œ) -->
  <section class="bg-stage">
    <img src="bg.png" alt="ë°°ê²½" />
    <header class="hero">
      <h1>ë¹„ëŒ€ë©´ ì°¨ëŸ‰ ê²¬ì  ìƒë‹´</h1>
      <p>ê°„ë‹¨í•œ ì¡°ê±´ ì…ë ¥ìœ¼ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤</p>
    </header>
  </section>

  <main class="wrap">
    <section class="sheet">
      <div class="sheet-inner">

        <!-- âœ… ë°ìŠ¤í¬íƒ‘ì´ë©´ 2ì»¬ëŸ¼, ëª¨ë°”ì¼ì´ë©´ 1ì»¬ëŸ¼ -->
        <div class="grid2">

          <!-- ======================
               1) ì°¨ëŸ‰ ì„ íƒ (ë³„ë„ div)
               ====================== -->
          <section class="sec" id="sec-car">
            <div class="sec-title">ì°¨ëŸ‰ ì„ íƒ <span class="badge">í•„ìˆ˜</span></div>

            <label>ìƒë‹´ ìœ í˜•</label>
            <div class="pillset" role="radiogroup" aria-label="ìƒë‹´ ìœ í˜•">
              <label class="pill">
                <input type="radio" name="dealType" value="ì¥ê¸°ë ŒíŠ¸" checked />
                ì¥ê¸°ë ŒíŠ¸
              </label>
              <label class="pill">
                <input type="radio" name="dealType" value="ë¦¬ìŠ¤" />
                ë¦¬ìŠ¤
              </label>
            </div>

            <label>ì°¨ëŸ‰ëª… ê²€ìƒ‰</label>
            <input id="q" type="text" placeholder="ì˜ˆ) ì˜ë Œí†  / ì…€í† ìŠ¤ / ì¹´ë‹ˆë°œ (ë¶€ë¶„ê²€ìƒ‰ ê°€ëŠ¥)" />

            <label>ì„ íƒëœ ì°¨ëŸ‰</label>
            <input id="selectedCar" type="text" value="ì•„ì§ ì„ íƒ ì „" readonly />

            <label>íŠ¸ë¦¼ ì„ íƒ</label>
            <select id="trimSelect" disabled>
              <option value="">ì°¨ëŸ‰ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>
            </select>

            <label>ì˜µì…˜ ì„ íƒ</label>
            <select id="optionSelect" multiple size="4" disabled>
              <option>íŠ¸ë¦¼ ì„ íƒ í›„ ì˜µì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤.</option>
            </select>
            <div class="hint">ì—¬ëŸ¬ ì˜µì…˜ì€ ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>

            <div class="price3" aria-label="ê¸ˆì•¡ ìš”ì•½">
              <div class="pricebox">
                <div class="k">ì°¨ëŸ‰ê°€</div>
                <div class="v" id="basePrice">0ì›</div>
              </div>
              <div class="pricebox">
                <div class="k">ì˜µì…˜ê°€</div>
                <div class="v" id="optPrice">0ì›</div>
              </div>
              <div class="pricebox">
                <div class="k">ì´ ì°¨ëŸ‰ê°€</div>
                <div class="v" id="totalPrice">0ì›</div>
              </div>
            </div>
          </section>

          <!-- ======================
               2) ìƒë‹´ ì¡°ê±´ + ì‹ ì²­ì ì •ë³´ (ë³„ë„ div)
               ====================== -->
          <div>
            <section class="sec" id="sec-cond">
              <div class="sec-title">ìƒë‹´ ì¡°ê±´ <span class="badge">í•„ìˆ˜</span></div>

              <div class="row2">
                <div>
                  <label>ì°¨ëŸ‰ ì¸ë„ ì§€ì—­</label>
                  <input id="region" type="text" placeholder="ì˜ˆ) ê²½ê¸° ë‚¨ë¶€ / ì„œìš¸ ê°•ë‚¨" />
                </div>
                <div>
                  <label>ê³ ê° ìœ í˜•</label>
                  <div class="pillset">
                    <label class="pill"><input type="radio" name="custType" value="ê°œì¸" checked />ê°œì¸</label>
                    <label class="pill"><input type="radio" name="custType" value="ê°œì¸ì‚¬ì—…ì" />ê°œì¸ì‚¬ì—…ì</label>
                    <label class="pill"><input type="radio" name="custType" value="ë²•ì¸" />ë²•ì¸</label>
                  </div>
                </div>
              </div>

              <label>ì°¨ëŸ‰ í•„ìš” ì‹œê¸° (ì„ íƒ)</label>
              <input id="needAt" type="text" placeholder="ì˜ˆ) ê°€ëŠ¥í•œ ë¹¨ë¦¬ / 2ì›” ì¤‘ìˆœ / ë¯¸ì •" />
              <div class="hint">* â€œë¯¸ì •â€ìœ¼ë¡œ ì…ë ¥í•´ë„ ê´œì°®ìŠµë‹ˆë‹¤.</div>
            </section>

            <section class="sec" id="sec-app" style="margin-top:12px;">
              <div class="sec-title">ì‹ ì²­ì ì •ë³´ <span class="badge">í•„ìˆ˜</span></div>

              <div class="row2">
                <div>
                  <label>ì‹ ì²­ìëª…</label>
                  <input id="name" type="text" placeholder="ì˜ˆ) í™ê¸¸ë™" />
                </div>
                <div>
                  <label>ì—°ë½ì²˜</label>
                  <input id="phone" type="tel" placeholder="ì˜ˆ) 010-1234-5678" />
                </div>
              </div>

              <label>ì¹´ì¹´ì˜¤í†¡ ID (ì„ íƒ)</label>
              <input id="kakao" type="text" placeholder="ì˜ˆ) melody7017" />

              <div class="agree">
                <input id="agree" type="checkbox" />
                <div>
                  <b>[í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</b>
                  <small>
                    ìˆ˜ì§‘: ì„±ëª…, ì—°ë½ì²˜, ì¹´ì¹´ì˜¤í†¡ ID(ì„ íƒ), ì°¨ëŸ‰ ì„ íƒ ì •ë³´<br/>
                    ëª©ì : ê²¬ì Â·ìƒë‹´ ì•ˆë‚´<br/>
                    ë³´ìœ : ìƒë‹´ ì™„ë£Œ í›„ 1ë…„
                  </small>
                </div>
              </div>

              <div class="cta">
                <button class="btn" id="submitBtn" disabled>ê°„ë‹¨ ê²¬ì  ìš”ì²­í•˜ê¸°</button>
                <div class="sub">ë°©ë¬¸ ì—†ì´ ëª¨ë‘ ë¹„ëŒ€ë©´ìœ¼ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.</div>
              </div>
            </section>
          </div>

        </div><!-- /grid2 -->

      </div><!-- /sheet-inner -->
    </section>
  </main>

  <script>
    /* =========================
       âœ… ì—¬ê¸°ë§Œ ë„ˆì˜ Apps Script URLë¡œ ë°”ê¿”ì¤˜
       - action=catalog : ëª¨ë¸/íŠ¸ë¦¼/ì˜µì…˜ ê°€ì ¸ì˜¤ê¸°
       - action=submit  : ì‹ ì²­ ì €ì¥
       ========================= */
    const CATALOG_URL = "https://script.google.com/macros/s/ì—¬ê¸°ì—ë„ˆì˜ì›¹ì•±ID/exec?action=catalog";
    const SUBMIT_URL  = "https://script.google.com/macros/s/ì—¬ê¸°ì—ë„ˆì˜ì›¹ì•±ID/exec?action=submit";

    const $ = (id)=>document.getElementById(id);

    const state = {
      catalog: [],        // Apps Scriptì—ì„œ ë°›ì€ ì›ë³¸
      picked: null,       // ì„ íƒ ì°¨ëŸ‰ row
      trims: [],          // íŠ¸ë¦¼ ëª©ë¡
      options: [],        // ì˜µì…˜ ëª©ë¡(íŠ¸ë¦¼ë³„)
      basePrice: 0,
      optPrice: 0
    };

    const fmt = (n)=> (Number(n||0)).toLocaleString("ko-KR") + "ì›";

    function updateTotals(){
      $("basePrice").textContent = fmt(state.basePrice);
      $("optPrice").textContent = fmt(state.optPrice);
      $("totalPrice").textContent = fmt(state.basePrice + state.optPrice);
    }

    function validate(){
      const ok =
        $("selectedCar").value !== "ì•„ì§ ì„ íƒ ì „" &&
        $("trimSelect").value &&
        $("region").value.trim() &&
        $("name").value.trim() &&
        $("phone").value.trim() &&
        $("agree").checked;

      $("submitBtn").disabled = !ok;
    }

    // ===== 1) ì¹´íƒˆë¡œê·¸ ë¡œë”© =====
    async function loadCatalog(){
      const res = await fetch(CATALOG_URL, { method:"GET" });
      const data = await res.json();

      // data ì˜ˆì‹œ(ê¶Œì¥):
      // { ok:true, models:[ {Maker, Model, Trim, TrimPrice, OptionsJSON, ...}, ... ] }
      if(!data || data.ok !== true) throw new Error("ì¹´íƒˆë¡œê·¸ ì‘ë‹µ ì˜¤ë¥˜");

      state.catalog = data.models || [];
    }

    // ===== 2) ê²€ìƒ‰ -> ì°¨ëŸ‰ ì„ íƒ(ëª¨ë¸ ë‹¨ìœ„ë¡œ) =====
    function findModelCandidates(q){
      q = (q||"").trim().toLowerCase();
      if(!q) return [];

      // Models ì‹œíŠ¸ëŠ” "ëª¨ë¸-íŠ¸ë¦¼" ë‹¨ìœ„ë¡œ ì—¬ëŸ¬ ì¤„ì¼ ê°€ëŠ¥ì„±ì´ í¼
      // => maker+model ë‹¨ìœ„ë¡œ dedup
      const map = new Map();
      for(const row of state.catalog){
        const maker = (row.Maker||"").toString();
        const model = (row.Model||"").toString();
        const key = maker + "||" + model;
        const hay = (maker + " " + model).toLowerCase();
        if(hay.includes(q) && !map.has(key)){
          map.set(key, { maker, model });
        }
      }
      return Array.from(map.values()).slice(0, 8);
    }

    // ëª¨ë°”ì¼ì—ì„œ ê°„ë‹¨ UX: ê²€ìƒ‰í•˜ë©´ promptë¡œ ì„ íƒ
    async function pickModelByPrompt(cands){
      const list = cands.map((c,i)=> `${i+1}. ${c.maker} ${c.model}`).join("\n");
      const ans = prompt("ì°¨ëŸ‰ì„ ì„ íƒí•˜ì„¸ìš” (ë²ˆí˜¸ ì…ë ¥)\n\n" + list);
      const idx = Number(ans) - 1;
      if(Number.isNaN(idx) || idx<0 || idx>=cands.length) return null;
      return cands[idx];
    }

    function getTrimsFor(maker, model){
      const rows = state.catalog.filter(r => (r.Maker||"")===maker && (r.Model||"")===model);
      // Trim ì¤‘ë³µ ì œê±° + ê°€ê²© ë§¤í•‘
      const map = new Map();
      for(const r of rows){
        const t = (r.Trim||"").toString();
        if(!t) continue;
        if(!map.has(t)){
          map.set(t, {
            trim: t,
            price: Number(r.TrimPrice||0),
            optionsJSON: r.OptionsJSON || r.Options || "[]"
          });
        }
      }
      return Array.from(map.values());
    }

    function renderTrims(trims){
      const sel = $("trimSelect");
      sel.innerHTML = `<option value="">íŠ¸ë¦¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>` + trims.map(t =>
        `<option value="${escapeHtml(t.trim)}" data-price="${t.price}" data-options='${escapeAttr(JSON.stringify(t.optionsJSON))}'>${escapeHtml(t.trim)}</option>`
      ).join("");
      sel.disabled = false;
    }

    function renderOptions(options){
      const sel = $("optionSelect");
      sel.innerHTML = options.map(o =>
        `<option value="${escapeHtml(o.name)}" data-price="${Number(o.price||0)}">${escapeHtml(o.name)} (+${fmt(Number(o.price||0))})</option>`
      ).join("");
      sel.disabled = false;
      sel.size = Math.min(6, Math.max(4, options.length || 4));
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      })[m]);
    }
    function escapeAttr(s){
      return String(s).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
    }

    // ===== ì´ë²¤íŠ¸ =====
    $("q").addEventListener("change", async ()=>{
      try{
        const cands = findModelCandidates($("q").value);
        if(!cands.length){
          alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.");
          return;
        }
        const picked = await pickModelByPrompt(cands);
        if(!picked) return;

        $("selectedCar").value = `${picked.maker} ${picked.model}`;
        // trims
        state.trims = getTrimsFor(picked.maker, picked.model);
        renderTrims(state.trims);

        // reset
        $("optionSelect").innerHTML = `<option>íŠ¸ë¦¼ ì„ íƒ í›„ ì˜µì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤.</option>`;
        $("optionSelect").disabled = true;
        state.basePrice = 0;
        state.optPrice = 0;
        updateTotals();
        validate();
      }catch(e){
        console.error(e);
        alert("ì°¨ëŸ‰ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
      }
    });

    $("trimSelect").addEventListener("change", ()=>{
      const v = $("trimSelect").value;
      const t = state.trims.find(x => x.trim === v);
      if(!t){
        state.basePrice = 0;
        state.optPrice = 0;
        updateTotals();
        validate();
        return;
      }

      state.basePrice = Number(t.price||0);

      // optionsJSON íŒŒì‹±(ì‹œíŠ¸ì— JSON ë¬¸ìì—´ë¡œ ë“¤ì–´ìˆë‹¤ëŠ” ê°€ì •)
      // ì˜ˆ: [{"name":"HUD","price":1200000},{"name":"ì„ ë£¨í”„","price":800000}]
      let arr = [];
      try{
        const raw = t.optionsJSON;
        arr = typeof raw === "string" ? JSON.parse(raw) : raw;
        if(!Array.isArray(arr)) arr = [];
      }catch(e){
        arr = [];
      }
      state.options = arr;
      renderOptions(arr);

      // ì˜µì…˜ ì„ íƒ ì´ˆê¸°í™”
      state.optPrice = 0;
      updateTotals();
      validate();
    });

    $("optionSelect").addEventListener("change", ()=>{
      let sum = 0;
      for(const opt of $("optionSelect").selectedOptions){
        sum += Number(opt.dataset.price||0);
      }
      state.optPrice = sum;
      updateTotals();
      validate();
    });

    ["region","needAt","name","phone","kakao","agree"].forEach(id=>{
      $(id).addEventListener("input", validate);
      $(id).addEventListener("change", validate);
    });

    // ===== ì œì¶œ =====
    $("submitBtn").addEventListener("click", async ()=>{
      try{
        $("submitBtn").disabled = true;

        const payload = {
          dealType: document.querySelector('input[name="dealType"]:checked')?.value || "",
          makerModel: $("selectedCar").value,
          trim: $("trimSelect").value,
          options: Array.from($("optionSelect").selectedOptions).map(o=>({
            name: o.value,
            price: Number(o.dataset.price||0)
          })),
          basePrice: state.basePrice,
          optPrice: state.optPrice,
          totalPrice: state.basePrice + state.optPrice,

          region: $("region").value.trim(),
          custType: document.querySelector('input[name="custType"]:checked')?.value || "",
          needAt: $("needAt").value.trim(),

          name: $("name").value.trim(),
          phone: $("phone").value.trim(),
          kakao: $("kakao").value.trim(),
          agree: $("agree").checked ? "Y" : "N"
        };

        const res = await fetch(SUBMIT_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if(!data || data.ok !== true) throw new Error("submit failed");

        alert("ì ‘ìˆ˜ ì™„ë£Œ! ê³§ ì•ˆë‚´ë“œë¦´ê²Œìš” ğŸ™‚");

        // í¼ ì´ˆê¸°í™”(ì„ íƒ ìœ ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ì´ ë¶€ë¶„ ì§€ì›Œë„ ë¨)
        $("q").value = "";
        $("selectedCar").value = "ì•„ì§ ì„ íƒ ì „";
        $("trimSelect").innerHTML = `<option value="">ì°¨ëŸ‰ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>`;
        $("trimSelect").disabled = true;
        $("optionSelect").innerHTML = `<option>íŠ¸ë¦¼ ì„ íƒ í›„ ì˜µì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤.</option>`;
        $("optionSelect").disabled = true;

        ["region","needAt","name","phone","kakao"].forEach(id=> $(id).value="");
        $("agree").checked = false;

        state.basePrice = 0; state.optPrice = 0;
        updateTotals();
        validate();
      }catch(e){
        console.error(e);
        alert("ì „ì†¡ ì‹¤íŒ¨â€¦ ë‹¤ì‹œ í•œ ë²ˆë§Œ ì‹œë„í•´ì¤˜!");
        validate();
      }
    });

    // ===== ìµœì´ˆ ì‹¤í–‰ =====
    (async ()=>{
      try{
        await loadCatalog();
        updateTotals();
        validate();
      }catch(e){
        console.error(e);
        alert("ì¹´íƒˆë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. Apps Script URLì„ í™•ì¸í•´ì¤˜!");
      }
    })();
  </script>

</body>
</html>
