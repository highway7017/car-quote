<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>비대면 차량 견적 상담</title>

  <style>
    :root{
      --text:#1f2328;
      --muted:rgba(31,35,40,.62);
      --card:rgba(255,255,255,.82);
      --shadow: 0 18px 55px rgba(0,0,0,.12);
      --softshadow: 0 10px 30px rgba(0,0,0,.10);
      --radius: 26px;
      --field: rgba(255,255,255,.92);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo","Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }

    .page-bg{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(1100px 680px at 50% 10%,
          rgba(255, 120, 190, .22) 0%,
          rgba(255, 190, 225, .14) 45%,
          rgba(255, 255, 255, 0) 78%
        ),
        linear-gradient(to bottom,
          rgba(255, 170, 220, .30) 0%,
          rgba(255, 215, 240, .18) 40%,
          rgba(255, 245, 252, .10) 72%,
          rgba(255, 255, 255, 1) 100%
        );
    }

    .hero{
      position:relative; z-index:1; width:100%;
      height:min(48vh, 220px); min-height:220px;
      display:flex; align-items:flex-end; justify-content:center;
      padding: 22px 16px 16px; overflow:hidden;
    }
    .hero::before{
      content:""; position:absolute; inset:0;
      background:url("./bg.png") center / cover no-repeat;
      filter:saturate(1.03) contrast(1.02);
    }
    .hero-title{
      position:relative; z-index:2;
      text-align:center; width:min(980px, 100%);
      padding: 0 10px 6px; color: rgba(15,15,18,.90);
    }
    .hero-title h1{
      margin:30px; font-weight:900; letter-spacing:-1px;
      font-size: clamp(22px, 5.2vw, 34px);
      text-shadow: 0 2px 18px rgba(255,255,255,.55);
    }

    .wrap{
      position:relative; z-index:2; width:min(980px, 100%);
      margin:-18px auto 32px; padding: 0 16px 24px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.45);
      border-radius: var(--radius);
      box-shadow: var(--softshadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card + .card{ margin-top: 14px; }
    .card-inner{ padding: 18px; }

    .sec-title{
      display:flex; align-items:center; gap:10px;
      margin:0 0 14px; font-weight:900; letter-spacing:-0.6px;
      font-size:18px;
    }
    .badge{
      margin-left: 6px; font-size: 12px; font-weight: 900;
      padding: 4px 10px; border-radius: 999px;
      color: rgba(140, 20, 95, .92);
      background: rgba(255, 120, 190, .14);
      border: 1px solid rgba(255, 120, 190, .18);
      white-space:nowrap;
    }

    label{ display:block; font-weight: 850; margin-top: 12px; letter-spacing: -.2px; }
    .help{ margin: 8px 0 0; font-size: 13px; color: var(--muted); font-weight: 700; }

    input, select{
      width:100%; margin-top:8px; padding:14px 14px;
      border-radius:16px; border:1px solid rgba(0,0,0,.10);
      background: var(--field); outline:none;
      font-size:15px; font-weight:800; color: rgba(18,18,22,.92);
      box-shadow: 0 1px 0 rgba(255,255,255,.65) inset;
    }
    input::placeholder{ color: rgba(0,0,0,.34); font-weight:800; }
    select:disabled, input:disabled{ opacity:.55; background: rgba(245,245,246,.85); }
    input:focus, select:focus{ border-color: rgba(255, 95, 170, .42); box-shadow: 0 0 0 4px rgba(255, 120, 190, .12); }

    .radio-row{ display:flex; gap:6px; margin-top:10px; flex-wrap:nowrap; font-size: 11px; }
    .radio-pill{
      flex:1 1 auto; min-width: 70px;
      display:flex; align-items:center; justify-content:center; gap:6px;
      padding: 10px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10); background: rgba(255,255,255,.92);
      font-weight: 800; cursor:pointer; user-select:none; white-space:nowrap;
    }
    .radio-pill input{ width:18px; height:18px; margin:0; padding:0; border-radius:999px; box-shadow:none; }

    .options-box{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
    }
    .options-box.is-hidden{ display:none; }

    .opt-grid{
      display:flex;
      flex-direction:column;      /* 한 줄에 하나 */
      gap:2px;                    /* ✅ 간격 줄임 */
      margin-top: 6px;
    }
    .opt-chip{
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
      padding: 2px 0;            /* ✅ 위아래 간격 더 줄임 */
      border:none;
      background: transparent;
      font-size: 10pt;
      font-weight: 650;
      cursor:pointer;
      user-select:none;
    }
    .opt-chip input{ width:18px; height:18px; margin:0; padding:0; box-shadow:none; }

    .consent{
      margin-top: 14px; padding: 14px;
      border-radius: 18px; background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
    }
    .consent-row{
      display:flex; align-items:flex-start; gap:10px;
      cursor:pointer; user-select:none;
    }
    .consent-row input{ width:20px; height:20px; margin: 2px 0 0; padding:0; box-shadow:none; }
    .consent strong{ display:block; font-weight:950; letter-spacing:-.3px; margin-bottom:6px; }
    .consent small{ display:block; color: var(--muted); font-weight:750; line-height:1.35; }

    .cta{ margin-top:14px; padding: 18px 16px 20px; text-align:center; }
    .btn{
      width:100%; border:0; border-radius:999px;
      padding:18px 18px; font-size:18px; font-weight:950; letter-spacing:-0.4px;
      color:#fff; cursor:pointer;
      background: linear-gradient(135deg,#ff3d9a 10%,#ff5fb3 50%,#c77dff 80%,#9b5cff 100%);
      box-shadow: 0 18px 40px rgba(255, 61, 154, .35), 0 12px 30px rgba(155, 92, 255, .35);
      position:relative; overflow:hidden;
    }
    .btn::after{
      content:""; position:absolute; inset:0;
      background: radial-gradient(600px 120px at 30% 0%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 60%);
      opacity:.65; pointer-events:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ cursor:not-allowed; opacity:.45; box-shadow:none; }

    .footer-note{
      margin-top: 10px; color: rgba(0,0,0,.42);
      font-weight: 800; font-size: 13px; line-height: 1.35;
    }

    .toast{
      position: fixed; left: 50%; bottom: 18px;
      transform: translateX(-50%);
      background: rgba(20,20,22,.86);
      color: #fff; padding: 10px 14px; border-radius: 999px;
      font-weight: 850; font-size: 13px;
      opacity: 0; pointer-events: none;
      transition: .18s ease;
      z-index: 50;
      max-width: min(92vw, 720px);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }

    @media (max-width: 420px){
      .card-inner{ padding: 16px; }
      .radio-row{ font-size: 10px; }
      .radio-pill{ min-width: 62px; padding: 9px 9px; }
    }
  </style>
</head>

<body>
  <div class="page-bg" aria-hidden="true"></div>

  <header class="hero">
    <div class="hero-title">
      <h1>렌트/리스 견적 신청</h1>
    </div>
  </header>

  <main class="wrap">
    <!-- 상품 유형 -->
    <div class="card">
      <div class="card-inner">
        <div class="sec-title">상품 유형 <span class="badge">필수</span></div>
        <div class="radio-row" role="radiogroup" aria-label="상품 유형">
          <label class="radio-pill">
            <input type="radio" name="dealType" value="렌트" checked />
            렌트
          </label>
          <label class="radio-pill">
            <input type="radio" name="dealType" value="리스" />
            리스
          </label>
        </div>
      </div>
    </div>

    <!-- 차량 선택 -->
    <div class="card">
      <div class="card-inner">
        <div class="sec-title">차량 선택 <span class="badge">필수</span></div>

        <label for="maker">제조사</label>
        <select id="maker">
          <option value="">제조사를 선택해주세요</option>
        </select>

       <label for="model">차종</label>
<select id="model" disabled>
  <option value="">차종을 선택해주세요</option>
</select>
        
        <label for="grade">차량 등급(트림)</label>
        <select id="grade" disabled>
          <option value="">차량 등급을 선택해주세요</option>
        </select>

 
        <div id="optionsBox" class="options-box is-hidden">
                  <label>옵션 (복수 선택 가능)</label>
          <div class="help" id="optionsHint" style="margin:0">트림을 선택하면 옵션이 표시됩니다.</div>
          <div id="optionsGrid" class="opt-grid"></div>
        </div>

        <p class="help">※ 제조사 → 차종 → 트림 → 옵션 순서로 선택됩니다.</p>
      </div>
    </div>

    <!-- 신청 정보 -->
    <div class="card">
      <div class="card-inner">
        <div class="sec-title">신청 정보 <span class="badge">필수</span></div>

        <label>고객 유형</label>
        <div class="radio-row" role="radiogroup" aria-label="고객 유형">
          <label class="radio-pill">
            <input type="radio" name="customerType" value="개인" checked />
            개인
          </label>
          <label class="radio-pill">
            <input type="radio" name="customerType" value="개인사업자" />
            개인사업자
          </label>
          <label class="radio-pill">
            <input type="radio" name="customerType" value="법인" />
            법인
          </label>
        </div>

        <label for="name">성명</label>
        <input id="name" placeholder="예) 홍길동" autocomplete="name" />

        <label for="phone">연락처</label>
        <input id="phone" placeholder="예) 010-1234-5678" inputmode="tel" autocomplete="tel" />

        <label for="deliveryTime">차량 인도 시기</label>
        <input id="deliveryTime" placeholder="예) 가능한 빨리 / 2월 중순 / 미정" />

        <label for="deliveryArea">차량 인도 지역</label>
        <input id="deliveryArea" placeholder="예) 서울 / 경기 남양주" />

        <label for="kakaoId">카카오톡 아이디 (선택)</label>
        <input id="kakaoId" placeholder="예) melody7017" autocomplete="off" />

        <div class="consent">
          <label class="consent-row" for="consent">
            <input id="consent" type="checkbox" />
            <div>
              <strong>[필수] 개인정보 수집·이용에 동의합니다.</strong>
              <small>
                수집: 성명, 연락처, 카카오톡 ID(선택), 차량 선택 정보 / 목적: 견적·상담 안내 /
                보유기간: 상담 완료 후 60일
              </small>
            </div>
          </label>
        </div>

        <div class="cta">
          <button id="submitBtn" class="btn" disabled>견적 요청하기</button>
          <div class="footer-note">
            문자 또는 카카오톡으로 안내 드립니다.<br>
            문자는 응대가 지연될 수 있습니다.
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" aria-live="polite"></div>

  <script>
/***************************************************************
 * ✅ 설정: Apps Script Web App URL
 ***************************************************************/
const API_BASE = "https://script.google.com/macros/s/AKfycbxpYN2m_14RHMJtHgSHj4t315mLlNJYJti9tZniR0iyb4-WuqeR9dc0GSFwjM_NG7m8-Q/exec";

/***************************************************************
 * ✅ DOM
 ***************************************************************/
const elMaker      = document.getElementById("maker");
const elModel      = document.getElementById("model");          // ✅ 차종 드롭다운(select) 버전
const elTrim       = document.getElementById("grade");          // 트림 select

const elOptionsBox  = document.getElementById("optionsBox");    // ✅ 트림 전엔 숨김
const elOptionsGrid = document.getElementById("optionsGrid");   // 체크박스 옵션 렌더

const elApplicantName = document.getElementById("name");
const elPhone         = document.getElementById("phone");
const elDeliveryTime  = document.getElementById("deliveryTime");
const elDeliveryArea  = document.getElementById("deliveryArea");
const elKakaoId = document.getElementById("kakaoId");

elKakaoId.addEventListener("input", (e)=>{
  // 영문(a-z, A-Z)만 허용
  e.target.value = e.target.value.replace(/[^a-zA-Z]/g, "");
  validate();
});
const elConsent       = document.getElementById("consent");

const elSubmit = document.getElementById("submitBtn");
const elToast  = document.getElementById("toast");

/***************************************************************
 * ✅ 상태
 ***************************************************************/
let catalogRows = []; // { maker, model, grade, option }
let makers = [];
const modelsByMaker = new Map();          // maker -> Set(models)
const gradesByMakerModel = new Map();     // maker||model -> Set(grades)
const optionsByTriple = new Map();        // maker||model||grade -> Set(options)

/***************************************************************
 * ✅ 유틸
 ***************************************************************/
const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

function toast(msg){
  if (!elToast) { alert(msg); return; }
  elToast.textContent = msg;
  elToast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> elToast.classList.remove("show"), 1700);
}

function norm(s){
  return (s ?? "").toString().replace(/\s+/g, " ").trim();
}

function key2(a,b){ return `${a}||${b}`; }
function key3(a,b,c){ return `${a}||${b}||${c}`; }

function phoneFormatLoose(v){
  const d = (v ?? "").toString().replace(/[^\d]/g,"").slice(0,11);
  if (d.length <= 3) return d;
  if (d.length <= 7) return `${d.slice(0,3)}-${d.slice(3)}`;
  return `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`;
}

function getCheckedValue(name, fallback){
  const r = document.querySelector(`input[name="${name}"]:checked`);
  return r ? r.value : fallback;
}

function fillSelect(selectEl, items, placeholder){
  if (!selectEl) return;
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  selectEl.appendChild(opt0);

  for (const it of items){
    const o = document.createElement("option");
    o.value = it;
    o.textContent = it;
    selectEl.appendChild(o);
  }
}

function disableSelect(selectEl, placeholder){
  if (!selectEl) return;
  selectEl.disabled = true;
  fillSelect(selectEl, [], placeholder);
}

function enableSelect(selectEl){
  if (!selectEl) return;
  selectEl.disabled = false;
}

/***************************************************************
 * ✅ 옵션 UI: 트림 전에는 완전 숨김
 ***************************************************************/
function hideOptionsBox(){
  if (!elOptionsBox) return;
  elOptionsBox.style.display = "none";
  if (elOptionsGrid) elOptionsGrid.innerHTML = "";
}

function showOptionsBox(){
  if (!elOptionsBox) return;
  elOptionsBox.style.display = "block";
}

function clearOptionsUI(){
  if (elOptionsGrid) elOptionsGrid.innerHTML = "";
}

function renderOptions(optionsArr){
  clearOptionsUI();

  // ✅ 트림 선택 후에만 이 함수가 호출되게 설계
  // 옵션이 없거나 "무옵션"만 있으면 무옵션만 보여주기
  const list = (optionsArr && optionsArr.length) ? optionsArr : ["무옵션"];

  // "무옵션"을 항상 맨 위에(중복 제거)
  const uniq = [...new Set(["무옵션", ...list.map(norm).filter(Boolean)])];

  for (const optName of uniq){
    const id = `opt_${Math.random().toString(16).slice(2)}`;

    const label = document.createElement("label");
    label.className = "opt-chip";
    label.setAttribute("for", id);

    const input = document.createElement("input");
    input.type = "checkbox";
    input.id = id;
    input.value = optName;
    input.name = "optionsChk";

    input.addEventListener("change", ()=>{
      const v = input.value;

      // 무옵션 체크하면 다른 옵션 해제
      if (v === "무옵션" && input.checked){
        document.querySelectorAll('input[name="optionsChk"]').forEach(ch=>{
          if (ch.value !== "무옵션") ch.checked = false;
        });
      }

      // 다른 옵션 체크하면 무옵션 해제
      if (v !== "무옵션" && input.checked){
        const none = [...document.querySelectorAll('input[name="optionsChk"]')].find(ch=>ch.value==="무옵션");
        if (none) none.checked = false;
      }

      validate();
    });

    const text = document.createElement("span");
    text.textContent = optName;

    label.appendChild(input);
    label.appendChild(text);
    elOptionsGrid.appendChild(label);
  }
}

function getSelectedOptionString(){
  const checked = [...document.querySelectorAll('input[name="optionsChk"]:checked')]
    .map(x=>norm(x.value))
    .filter(Boolean);

  // 아무것도 선택 안 하면 무옵션
  if (checked.length === 0) return "무옵션";

  // 무옵션만 체크됐으면 무옵션
  if (checked.length === 1 && checked[0] === "무옵션") return "무옵션";

  // 무옵션 섞이면 제거
  const cleaned = checked.filter(x => x !== "무옵션");
  return cleaned.length ? cleaned.join(" / ") : "무옵션";   // ✅ / 로 구분
}

/***************************************************************
 * ✅ 검증
 * - 옵션은 필수 아님 (선택 없으면 무옵션으로 저장)
 ***************************************************************/
function validate(){
  const ok =
    !!norm(elMaker?.value) &&
    !!norm(elModel?.value) &&
    !!norm(elTrim?.value) &&
    !!norm(elApplicantName?.value) &&
    !!norm(elPhone?.value) &&
    !!norm(elDeliveryTime?.value) &&
    !!norm(elDeliveryArea?.value) &&
    !!elConsent?.checked;

  if (elSubmit) elSubmit.disabled = !ok;
  return ok;
}

/***************************************************************
 * ✅ 카탈로그 불러오기 (JSON 아닌 경우 방어)
 ***************************************************************/
async function fetchCatalog(){
  const url = `${API_BASE}?action=catalog&_=${Date.now()}`;

  let res, text;
  try{
    res = await fetch(url, { method:"GET", cache:"no-store" });
    text = await res.text();
  }catch(e){
    console.error(e);
    toast("카탈로그 호출 실패(네트워크/권한)");
    return;
  }

  let data;
  try{
    data = JSON.parse(text);
  }catch(e){
    console.error("NOT JSON:", text);
    toast("카탈로그 응답이 JSON이 아님 (Apps Script 출력 확인)");
    alert(text.slice(0, 600));
    return;
  }

  const rows = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? []);
  if (!Array.isArray(rows) || rows.length === 0){
    console.warn("EMPTY payload:", data);
    toast("카탈로그가 비어있어요 (Models 시트 확인)");
    alert(JSON.stringify(data).slice(0, 600));
    return;
  }

  // ✅ 컬럼 매핑(너가 현재 시트에서 통일한 키 기준)
  // Models 시트: maker, model, grade, option  (option에 "무옵션" 포함 가능)
  catalogRows = rows.map(r => ({
    maker:  norm(r.maker ?? r.제조사 ?? r.Maker),
    model:  norm(r.model ?? r.차종 ?? r.Model),
    grade:  norm(r.grade ?? r.trim ?? r.트림 ?? r.등급 ?? r.Trim),
    option: norm(r.option ?? r.options ?? r.옵션 ?? r.Option)
  })).filter(r => r.maker && r.model && r.grade); // ✅ option은 빈 값일 수도 있으니 grade까지만 필수

  if (catalogRows.length === 0){
    toast("Models 컬럼명이 안 맞아요. maker/model/grade/option 확인!");
    return;
  }

  buildIndexes();
  hydrateMaker();
  toast("차량 목록을 불러왔어요.");
}

function buildIndexes(){
  makers = [];
  modelsByMaker.clear();
  gradesByMakerModel.clear();
  optionsByTriple.clear();

  const makerSet = new Set();

  for (const r of catalogRows){
    makerSet.add(r.maker);

    if (!modelsByMaker.has(r.maker)) modelsByMaker.set(r.maker, new Set());
    modelsByMaker.get(r.maker).add(r.model);

    const k2 = key2(r.maker, r.model);
    if (!gradesByMakerModel.has(k2)) gradesByMakerModel.set(k2, new Set());
    gradesByMakerModel.get(k2).add(r.grade);

    const k3 = key3(r.maker, r.model, r.grade);
    if (!optionsByTriple.has(k3)) optionsByTriple.set(k3, new Set());
    if (r.option) optionsByTriple.get(k3).add(r.option); // "무옵션"도 올 수 있음
  }

  makers = [...makerSet].sort((a,b)=>a.localeCompare(b,"ko"));
}

function hydrateMaker(){
  fillSelect(elMaker, makers, "제조사를 선택해주세요");

  // reset downstream
  disableSelect(elModel, "차종을 선택해주세요");
  disableSelect(elTrim, "차량 등급을 선택해주세요");

  hideOptionsBox();        // ✅ 트림 전엔 옵션 영역 숨김
  validate();
}

/***************************************************************
 * ✅ 선택 체인
 * maker -> model(select) -> grade(select) -> options(checkbox, 트림 후 표시)
 ***************************************************************/
elMaker?.addEventListener("change", ()=>{
  const maker = norm(elMaker.value);

  // reset downstream
  disableSelect(elModel, "차종을 선택해주세요");
  disableSelect(elTrim, "차량 등급을 선택해주세요");
  hideOptionsBox();

  if (!maker){ validate(); return; }

  const models = [...(modelsByMaker.get(maker) ?? new Set())]
    .map(norm)
    .filter(Boolean)
    .sort((a,b)=>a.localeCompare(b,"ko"));

  fillSelect(elModel, models, "차종을 선택해주세요");
  enableSelect(elModel);
  validate();
});

elModel?.addEventListener("change", ()=>{
  const maker = norm(elMaker.value);
  const model = norm(elModel.value);

  // reset downstream
  disableSelect(elTrim, "차량 등급을 선택해주세요");
  hideOptionsBox();

  if (!maker || !model){ validate(); return; }

  const grades = [...(gradesByMakerModel.get(key2(maker, model)) ?? new Set())]
    .map(norm)
    .filter(Boolean)
    .sort((a,b)=>a.localeCompare(b,"ko"));

  fillSelect(elTrim, grades, "차량 등급을 선택해주세요");
  enableSelect(elTrim);
  validate();
});

elTrim?.addEventListener("change", ()=>{
  const maker = norm(elMaker.value);
  const model = norm(elModel.value);
  const grade = norm(elTrim.value);

  hideOptionsBox(); // 일단 숨겼다가, 조건 맞으면 표시

  if (!maker || !model || !grade){
    validate();
    return;
  }

  const opts = [...(optionsByTriple.get(key3(maker, model, grade)) ?? new Set())]
    .map(norm)
    .filter(Boolean);

  // ✅ 트림 선택했으니 이제 옵션 영역 보여주고 렌더
  showOptionsBox();
  renderOptions(opts);
  validate();
});

/***************************************************************
 * ✅ 입력 변화들
 ***************************************************************/
elApplicantName?.addEventListener("input", validate);
elDeliveryTime?.addEventListener("input", validate);
elDeliveryArea?.addEventListener("input", validate);
elKakaoId?.addEventListener("input", validate);
elConsent?.addEventListener("change", validate);

elPhone?.addEventListener("input", (e)=>{
  e.target.value = phoneFormatLoose(e.target.value);
  validate();
});

document.querySelectorAll('input[name="dealType"], input[name="customerType"]').forEach(el=>{
  el.addEventListener("change", validate);
});

/***************************************************************
 * ✅ 제출
 * - 시트 헤더(너가 말한 최종): 
 * submittedAt, from, dealType, maker, model, grade, option,
 * customerType, name, phone, deliveryTime, deliveryArea, kakaoId, consent
 ***************************************************************/
async function fetchJsonLoose(url, options){
  const res = await fetch(url, options);
  const text = await res.text();
  try{
    return { ok: res.ok, data: JSON.parse(text), rawText: text, status: res.status };
  }catch(e){
    return { ok:false, data:null, rawText:text, status:res.status, parseError:e };
  }
}

async function submitApplication(){
  if (!validate()){
    toast("필수 항목을 확인해주세요.");
    return;
  }

  elSubmit.disabled = true;
  elSubmit.textContent = "전송 중…";

  const payload = {
    action: "apply",
    submittedAt: new Date().toISOString(),
    from: "github-pages",
    dealType: getCheckedValue("dealType", "렌트"),

    maker: norm(elMaker.value),
    model: norm(elModel.value),
    grade: norm(elTrim.value),

    option: getSelectedOptionString(),              // ✅ / 로 구분된 문자열

    customerType: getCheckedValue("customerType", "개인"),
    name: norm(elApplicantName.value),
    phone: norm(elPhone.value),
    deliveryTime: norm(elDeliveryTime.value),
    deliveryArea: norm(elDeliveryArea.value),
    kakaoId: norm(elKakaoId.value),

    consent: elConsent.checked ? "Y" : "N"
  };

  let ok = false;
  let message = "접수 완료! 곧 안내드릴게요.";

  // 1) POST(JSON)
  try{
    const r = await fetchJsonLoose(`${API_BASE}?action=apply`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if (r.data && (r.data.ok !== false)){
      ok = true;
      if (r.data.message) message = r.data.message;
    } else {
      throw new Error("POST failed");
    }
  }catch(e){
    // 2) GET fallback
    try{
      const qs = new URLSearchParams(payload).toString();
      const r2 = await fetchJsonLoose(`${API_BASE}?${qs}`, { method:"GET", cache:"no-store" });
      if (r2.data && (r2.data.ok !== false)){
        ok = true;
        if (r2.data.message) message = r2.data.message;
      } else {
        throw new Error("GET failed");
      }
    }catch(e2){
      console.error(e2);
    }
  }

  await sleep(200);

  if (ok){
    toast(message);

    // ✅ 신청 정보만 리셋(차량 선택 유지)
    elApplicantName.value = "";
    elPhone.value = "";
    elDeliveryTime.value = "";
    elDeliveryArea.value = "";
    elKakaoId.value = "";
    elConsent.checked = false;

    // 옵션은 트림 선택 상태라면: 선택만 해제(무옵션 자동 저장됨)
    if (elTrim.value){
      // 렌더를 유지하되 체크 해제
      document.querySelectorAll('input[name="optionsChk"]').forEach(ch=> ch.checked = false);
    } else {
      hideOptionsBox();
    }

    // 라디오 기본값
    const ct = document.querySelector('input[name="customerType"][value="개인"]');
    if (ct) ct.checked = true;

    const dt = document.querySelector('input[name="dealType"][value="렌트"]');
    if (dt) dt.checked = true;

  }else{
    toast("전송 실패. 웹앱 배포/권한/응답(JSON) 확인해주세요.");
  }

  elSubmit.textContent = "견적 요청하기";
  validate();
}

elSubmit?.addEventListener("click", submitApplication);

/***************************************************************
 * ✅ 시작
 ***************************************************************/
(async function init(){
  hideOptionsBox();   // ✅ 처음엔 옵션 숨김
  validate();
  await fetchCatalog();
})();
</script>
</body>
</html>
