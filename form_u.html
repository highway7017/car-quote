<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>비대면 차량 견적 상담</title>

  <style>
    :root{
      --text:#1f2328;
      --muted:rgba(31,35,40,.62);
      --card:rgba(255,255,255,.82);
      --softshadow: 0 10px 30px rgba(0,0,0,.10);
      --radius: 26px;
      --field: rgba(255,255,255,.92);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo","Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }

    .page-bg{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(1100px 680px at 50% 10%,
          rgba(255, 120, 190, .22) 0%,
          rgba(255, 190, 225, .14) 45%,
          rgba(255, 255, 255, 0) 78%
        ),
        linear-gradient(to bottom,
          rgba(255, 170, 220, .30) 0%,
          rgba(255, 215, 240, .18) 40%,
          rgba(255, 245, 252, .10) 72%,
          rgba(255, 255, 255, 1) 100%
        );
    }

    .hero{
      position:relative; z-index:1;
      width:100%; height:min(48vh, 220px); min-height:220px;
      display:flex; align-items:flex-end; justify-content:center;
      padding:22px 16px 16px;
      overflow:hidden;
    }
    .hero::before{
      content:""; position:absolute; inset:0;
      background:url("./bg.png") center / cover no-repeat;
      filter:saturate(1.03) contrast(1.02);
    }
    .hero-title{
      position:relative; z-index:2; text-align:center;
      width:min(980px, 100%); padding:0 10px 6px;
      color: rgba(15,15,18,.90);
    }
    .hero-title h1{
      margin:30px;
      font-weight:900; letter-spacing:-1px;
      font-size: clamp(22px, 5.2vw, 34px);
      text-shadow: 0 2px 18px rgba(255,255,255,.55);
    }

    .wrap{
      position:relative; z-index:2;
      width:min(980px, 100%);
      margin:-18px auto 32px;
      padding: 0 16px 24px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.45);
      border-radius: var(--radius);
      box-shadow: var(--softshadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card + .card{ margin-top: 14px; }
    .card-inner{ padding: 18px; }

    .sec-title{
      display:flex; align-items:center; gap:10px;
      margin:0 0 14px;
      font-weight:900; letter-spacing:-0.6px;
      font-size:18px;
    }
    .badge{
      margin-left: 6px;
      font-size: 12px; font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      color: rgba(140, 20, 95, .92);
      background: rgba(255, 120, 190, .14);
      border: 1px solid rgba(255, 120, 190, .18);
      white-space:nowrap;
    }

    label{
      display:block;
      font-weight: 850;
      margin-top: 12px;
      letter-spacing: -.2px;
    }
    .help{
      margin: 8px 0 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }

    input, select{
      width:100%;
      margin-top:8px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background: var(--field);
      outline:none;
      font-size:15px;
      font-weight:800;
      color: rgba(18,18,22,.92);
      box-shadow: 0 1px 0 rgba(255,255,255,.65) inset;
    }
    input::placeholder{ color: rgba(0,0,0,.34); font-weight:800; }
    select:disabled, input:disabled{
      opacity:.55;
      background: rgba(245,245,246,.85);
    }
    input:focus, select:focus{
      border-color: rgba(255, 95, 170, .42);
      box-shadow: 0 0 0 4px rgba(255, 120, 190, .12);
    }

    .radio-row{
      display:flex;
      gap:6px;
      margin-top:10px;
      flex-wrap:nowrap;
      font-size: 11px;
    }
    .radio-pill{
      flex:1 1 auto;
      min-width: 70px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding: 10px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.92);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .radio-pill input{
      width:18px; height:18px; margin:0; padding:0;
      border-radius:999px;
      box-shadow:none;
    }

    /* 옵션 체크박스 박스 */
    .options-box{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
    }
    .opt-grid{
      display:flex;
      flex-direction:column;
      gap:2px;             /* ✅ 간격 더 촘촘 */
      margin-top: 6px;
    }
    .opt-chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 2px 0;      /* ✅ 위아래 더 줄임 */
      border:none;
      background: transparent;
      font-size: 12px;
      font-weight: 700;
      cursor:pointer;
      user-select:none;
      line-height:1.2;
    }
    .opt-chip input{
      width:18px; height:18px; margin:0; padding:0; box-shadow:none;
    }

    /* 텍스트 입력 모드(수입차/기타) */
    .manual-box{
      margin-top: 10px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
    }
    .manual-box .help{ margin-top: 0; }

    .consent{
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
    }
    .consent-row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .consent-row input{
      width:20px;
      height:20px;
      margin: 2px 0 0;
      padding:0;
      box-shadow:none;
    }
    .consent strong{
      display:block;
      font-weight:950;
      letter-spacing:-.3px;
      margin-bottom:6px;
    }
    .consent small{
      display:block;
      color: var(--muted);
      font-weight:750;
      line-height:1.35;
    }

    .cta{
      margin-top:14px;
      padding: 18px 16px 20px;
      text-align:center;
    }
    .btn{
      width:100%;
      border:0;
      border-radius:999px;
      padding:18px 18px;
      font-size:18px;
      font-weight:950;
      letter-spacing:-0.4px;
      color:#fff;
      cursor:pointer;
      background: linear-gradient(135deg,#ff3d9a 10%,#ff5fb3 50%,#c77dff 80%,#9b5cff 100%);
      box-shadow: 0 18px 40px rgba(255, 61, 154, .35), 0 12px 30px rgba(155, 92, 255, .35);
      position:relative;
      overflow:hidden;
    }
    .btn::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(600px 120px at 30% 0%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 60%);
      opacity:.65;
      pointer-events:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ cursor:not-allowed; opacity:.45; box-shadow:none; }

    .footer-note{
      margin-top: 10px;
      color: rgba(0,0,0,.42);
      font-weight: 800;
      font-size: 13px;
      line-height: 1.35;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(20,20,22,.86);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: .18s ease;
      z-index: 50;
      max-width: min(92vw, 720px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }

    .hidden{ display:none !important; }

    @media (max-width: 420px){
      .card-inner{ padding: 16px; }
      .radio-row{ font-size: 10px; }
      .radio-pill{ min-width: 62px; padding: 9px 9px; }
    }
  </style>
</head>

<body>
  <div class="page-bg" aria-hidden="true"></div>

  <header class="hero">
    <div class="hero-title">
      <h1>렌트/리스 견적 신청</h1>
    </div>
  </header>

  <main class="wrap">
    <!-- 상품 유형 -->
    <div class="card">
      <div class="card-inner">
        <div class="sec-title">상품 유형 <span class="badge">필수</span></div>
        <div class="radio-row" role="radiogroup" aria-label="상품 유형">
          <label class="radio-pill">
            <input type="radio" name="productType" value="렌트" checked />
            렌트
          </label>
          <label class="radio-pill">
            <input type="radio" name="productType" value="리스" />
            리스
          </label>
        </div>
      </div>
    </div>

    <!-- 차량 선택 -->
    <div class="card">
      <div class="card-inner">
        <div class="sec-title">차량 선택 <span class="badge">필수</span></div>

        <label for="maker">제조사</label>
        <select id="maker">
          <option value="">제조사를 선택해주세요</option>
        </select>

        <!-- 국내 제조사 모드 -->
        <div id="domesticMode">
          <label for="model">차종</label>
          <select id="model" disabled>
            <option value="">차종을 선택해주세요</option>
          </select>

          <label for="grade">차량 등급(트림)</label>
          <select id="grade" disabled>
            <option value="">트림을 선택해주세요</option>
          </select>

          <label>옵션 (복수 선택 가능 / 선택 안 하면 무옵션)</label>
          <div id="optionsBox" class="options-box hidden">
            <div class="help" style="margin:0">트림을 선택하면 옵션이 표시됩니다.</div>
            <div id="optionsGrid" class="opt-grid"></div>
          </div>

          <p class="help">※ 제조사 → 차종 → 트림 → 옵션 순서로 선택됩니다.</p>
        </div>

        <!-- 수입차/기타 모드 -->
        <div id="manualMode" class="manual-box hidden">
          <div class="help">수입차/기타는 차량 정보를 직접 입력해주세요.</div>

          <label for="manualModel">차종(직접입력)</label>
          <input id="manualModel" placeholder="예) BMW 520i" />

          <label for="manualGrade">트림(직접입력)</label>
          <input id="manualGrade" placeholder="예) M Sport / 2.0 터보"/>

          <label for="manualOption">옵션(직접입력)</label>
          <input id="manualOption" placeholder="예) HUD/어라운드뷰/선루프" />
        </div>
      </div>
    </div>

    <!-- 신청 정보 -->
    <div class="card">
      <div class="card-inner">
        <div class="sec-title">신청 정보 <span class="badge">필수</span></div>

        <label>고객 유형</label>
        <div class="radio-row" role="radiogroup" aria-label="고객 유형">
          <label class="radio-pill">
            <input type="radio" name="customerType" value="개인" checked />
            개인
          </label>
          <label class="radio-pill">
            <input type="radio" name="customerType" value="개인사업자" />
            개인사업자
          </label>
          <label class="radio-pill">
            <input type="radio" name="customerType" value="법인" />
            법인
          </label>
        </div>

        <label for="name">성명</label>
        <input id="name" placeholder="예) 홍길동" autocomplete="name" />

        <label for="phone">연락처</label>
        <input id="phone" placeholder="예) 010-1234-5678" inputmode="tel" autocomplete="tel" />

        <label for="deliveryTime">차량 인도 시기</label>
        <input id="deliveryTime" placeholder="예) 가능한 빨리 / 2월 중순 / 미정" />

        <label for="deliveryArea">차량 인도 지역</label>
        <input id="deliveryArea" placeholder="예) 서울 / 경기 남양주" />

        <label for="kakaoId">카카오톡 아이디 (선택)</label>
        <input id="kakaoId" placeholder="예) melody7017" autocomplete="off" />

        <div class="consent">
          <label class="consent-row" for="agree">
            <input id="agree" type="checkbox" />
            <div>
              <strong>[필수] 개인정보 수집·이용에 동의합니다.</strong>
              <small>
                수집: 성명, 연락처, 카카오톡 ID(선택), 차량 선택 정보 / 목적: 견적·상담 안내 /
                보유: 상담 완료 후 1년
              </small>
            </div>
          </label>
        </div>

        <div class="cta">
          <button id="submitBtn" class="btn" disabled>간단 견적 요청하기</button>
          <div class="footer-note">
            문자 또는 카카오톡으로 안내 드립니다.<br>
            문자는 응대가 지연될 수 있습니다.
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" aria-live="polite"></div>

  <script>
    /***************************************************************
     * ✅ 웹앱 URL
     ***************************************************************/
    const API_BASE = "https://script.google.com/macros/s/AKfycbyllGUZg9rKkYWN_EWNKHsK_zLMnt3JnXHZKMhhd8DR6PTY_eSMxrpXybWjIl7iw_lWPQ/exec";

    /***************************************************************
     * ✅ DOM
     ***************************************************************/
    const elMaker = document.getElementById("maker");
    const elModel = document.getElementById("model");
    const elGrade = document.getElementById("grade");

    const domesticMode = document.getElementById("domesticMode");
    const manualMode = document.getElementById("manualMode");

    const elOptionsBox = document.getElementById("optionsBox");
    const elOptionsGrid = document.getElementById("optionsGrid");

    const elManualModel = document.getElementById("manualModel");
    const elManualGrade = document.getElementById("manualGrade");
    const elManualOption = document.getElementById("manualOption");

    const elName = document.getElementById("name");
    const elPhone = document.getElementById("phone");
    const elDeliveryTime = document.getElementById("deliveryTime");
    const elDeliveryArea = document.getElementById("deliveryArea");
    const elKakaoId = document.getElementById("kakaoId");
    const elAgree = document.getElementById("agree");

    const elSubmit = document.getElementById("submitBtn");
    const elToast = document.getElementById("toast");

    /***************************************************************
     * ✅ 상태
     ***************************************************************/
    let catalogRows = []; // { maker, model, grade, option }
    const modelsByMaker = new Map();       // maker -> Set(model)
    const gradesByMM = new Map();          // maker||model -> Set(grade)
    const optionsByMMG = new Map();        // maker||model||grade -> Set(option)

    // 제조사 표시 순서 강제
    const MAKER_ORDER = ["기아","현대","르노","테슬라","수입차","기타"];
    const SPECIAL_MAKERS = new Set(["수입차","기타"]);

    /***************************************************************
     * ✅ 유틸
     ***************************************************************/
    function toast(msg){
      elToast.textContent = msg;
      elToast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> elToast.classList.remove("show"), 1700);
    }

    function norm(s){
      return (s ?? "").toString().trim().replace(/\s+/g, " ");
    }

    function key2(a,b){ return `${a}||${b}`; }
    function key3(a,b,c){ return `${a}||${b}||${c}`; }

    function fillSelect(sel, items, placeholder){
      sel.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = "";
      o0.textContent = placeholder;
      sel.appendChild(o0);

      for (const it of items){
        const o = document.createElement("option");
        o.value = it;
        o.textContent = it;
        sel.appendChild(o);
      }
    }

    function setDisabled(sel, disabled){
      sel.disabled = !!disabled;
    }

    function phoneFormatLoose(v){
      const d = (v ?? "").toString().replace(/[^\d]/g,"").slice(0,11);
      if (d.length <= 3) return d;
      if (d.length <= 7) return `${d.slice(0,3)}-${d.slice(3)}`;
      return `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`;
    }

    function getCheckedValue(name, fallback){
      const r = document.querySelector(`input[name="${name}"]:checked`);
      return r ? r.value : fallback;
    }

    function hide(el){ el.classList.add("hidden"); }
    function show(el){ el.classList.remove("hidden"); }

    /***************************************************************
     * ✅ 옵션 UI
     ***************************************************************/
    function clearOptionsUI(){
      elOptionsGrid.innerHTML = "";
    }

    function renderOptions(optionsArr){
      clearOptionsUI();

      // 트림 선택 전에는 숨김
      if (!optionsArr){
        hide(elOptionsBox);
        return;
      }

      // 옵션이 없으면 빈 배열일 수 있음 -> 체크박스는 표시하되 아무것도 체크 안 하면 무옵션 처리
      show(elOptionsBox);

      const uniq = [...new Set((optionsArr || []).map(norm).filter(Boolean))];

      if (uniq.length === 0){
        // 보여줄 옵션이 아예 없으면 안내만 (체크박스 없음)
        const div = document.createElement("div");
        div.className = "help";
        div.style.marginTop = "6px";
        div.textContent = "선택 가능한 옵션이 없습니다. (선택 안 하면 무옵션)";
        elOptionsGrid.appendChild(div);
        return;
      }

      for (const optName of uniq){
        const id = `opt_${Math.random().toString(16).slice(2)}`;
        const label = document.createElement("label");
        label.className = "opt-chip";
        label.setAttribute("for", id);

        const input = document.createElement("input");
        input.type = "checkbox";
        input.id = id;
        input.value = optName;
        input.name = "optionsChk";
        input.addEventListener("change", validate);

        const text = document.createElement("span");
        text.textContent = optName;

        label.appendChild(input);
        label.appendChild(text);
        elOptionsGrid.appendChild(label);
      }
    }

    function getSelectedOptionsSlash(){
      const checked = [...document.querySelectorAll('input[name="optionsChk"]:checked')]
        .map(x=>norm(x.value))
        .filter(Boolean);

      if (checked.length === 0) return "무옵션";
      return checked.join("/"); // ✅ / 로 구분
    }

    /***************************************************************
     * ✅ 모드 전환 (국내 vs 수입차/기타)
     ***************************************************************/
    function setModeSpecial(isSpecial){
      if (isSpecial){
        hide(domesticMode);
        show(manualMode);

        // 국내 드롭다운 값 초기화/비활성
        elModel.value = "";
        elGrade.value = "";
        fillSelect(elModel, [], "차종을 선택해주세요");
        fillSelect(elGrade, [], "트림을 선택해주세요");
        setDisabled(elModel, true);
        setDisabled(elGrade, true);
        renderOptions(null); // 옵션 숨김
      }else{
        show(domesticMode);
        hide(manualMode);

        // 수입/기타 입력값 초기화는 강제하지 않음(원하면 여기서 비우기)
        // elManualModel.value = ""; elManualGrade.value = ""; elManualOption.value = "";
      }
      validate();
    }

    /***************************************************************
     * ✅ 검증
     ***************************************************************/
    function validate(){
      const maker = norm(elMaker.value);
      const isSpecial = SPECIAL_MAKERS.has(maker);

      let carOk = false;
      if (isSpecial){
        carOk = !!norm(elManualModel.value) && !!norm(elManualGrade.value); // 옵션은 선택
      }else{
        carOk = !!norm(elModel.value) && !!norm(elGrade.value);
      }

      const ok =
        !!maker &&
        carOk &&
        !!norm(elName.value) &&
        !!norm(elPhone.value) &&
        !!norm(elDeliveryTime.value) &&
        !!norm(elDeliveryArea.value) &&
        !!elAgree.checked;

      elSubmit.disabled = !ok;
      return ok;
    }

    /***************************************************************
     * ✅ 카탈로그 불러오기
     ***************************************************************/
    async function fetchCatalog(){
      const url = `${API_BASE}?action=catalog&_=${Date.now()}`;

      let res, text, data;
      try{
        res = await fetch(url, { method:"GET", cache:"no-store" });
        text = await res.text();
      }catch(e){
        console.error(e);
        toast("카탈로그 호출 실패(네트워크/권한)");
        return;
      }

      try{
        data = JSON.parse(text);
      }catch(e){
        console.error("NOT JSON:", text);
        toast("카탈로그 응답이 JSON이 아님");
        alert(text.slice(0, 500));
        return;
      }

      const rows = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? []);
      if (!Array.isArray(rows) || rows.length === 0){
        toast("카탈로그가 비어있어요 (Models 시트 확인)");
        alert(JSON.stringify(data).slice(0, 500));
        return;
      }

      // rows: 객체 배열이어야 함 (Apps Script가 2차원 배열이면 여기서 걸림)
      // => 객체형 변환 방어: 첫 줄이 헤더인 2차원 배열이면 객체로 변환
      let objRows = rows;
      if (Array.isArray(rows[0])) {
        // 2차원 배열: [ [header...], [row...], ... ]
        const headers = rows[0].map(h=>norm(h));
        objRows = rows.slice(1).map(r=>{
          const o = {};
          headers.forEach((h, i)=>{ if(h) o[h] = r[i]; });
          return o;
        });
      }

      catalogRows = objRows.map(r => ({
        maker:  norm(r.maker ?? r.제조사 ?? r.Maker),
        model:  norm(r.model ?? r.차종 ?? r.Model),
        grade:  norm(r.grade ?? r.트림 ?? r.등급 ?? r.Trim),
        option: norm(r.option ?? r.options ?? r.옵션 ?? r.Option)
      })).filter(x => x.maker && x.model && x.grade); // option은 없어도 됨

      if (catalogRows.length === 0){
        toast("Models 컬럼명이 안 맞아요 (maker/model/grade/option)");
        return;
      }

      buildIndexes();
      hydrateMaker();
      toast("차량 목록을 불러왔어요.");
    }

    function buildIndexes(){
      modelsByMaker.clear();
      gradesByMM.clear();
      optionsByMMG.clear();

      for (const r of catalogRows){
        if (!modelsByMaker.has(r.maker)) modelsByMaker.set(r.maker, new Set());
        modelsByMaker.get(r.maker).add(r.model);

        const k2 = key2(r.maker, r.model);
        if (!gradesByMM.has(k2)) gradesByMM.set(k2, new Set());
        gradesByMM.get(k2).add(r.grade);

        const k3 = key3(r.maker, r.model, r.grade);
        if (!optionsByMMG.has(k3)) optionsByMMG.set(k3, new Set());
        if (r.option) optionsByMMG.get(k3).add(r.option);
      }
    }

    function hydrateMaker(){
  // ✅ 무조건 고정 순서만 노출
  const makers = ["기아","현대","르노","테슬라","수입차","기타"];
  fillSelect(elMaker, makers, "제조사를 선택해주세요");

  // 초기화
  fillSelect(elModel, [], "차종을 선택해주세요");
  fillSelect(elGrade, [], "트림을 선택해주세요");
  setDisabled(elModel, true);
  setDisabled(elGrade, true);
  renderOptions(null);

  // 모드 초기
  setModeSpecial(false);
  validate();
}

    /***************************************************************
     * ✅ 선택 체인
     ***************************************************************/
    elMaker.addEventListener("change", ()=>{
      const maker = norm(elMaker.value);
      const isSpecial = SPECIAL_MAKERS.has(maker);

      // 모드 전환
      setModeSpecial(isSpecial);

      if (!maker || isSpecial){
        return;
      }

      // 국내: 차종 채우기
      const models = [...(modelsByMaker.get(maker) ?? new Set())]
        .map(norm).filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,"ko"));

      fillSelect(elModel, models, "차종을 선택해주세요");
      setDisabled(elModel, false);

      // 하위 초기화
      fillSelect(elGrade, [], "트림을 선택해주세요");
      setDisabled(elGrade, true);
      renderOptions(null);

      validate();
    });

    elModel.addEventListener("change", ()=>{
      const maker = norm(elMaker.value);
      const model = norm(elModel.value);

      // 하위 초기화
      fillSelect(elGrade, [], "트림을 선택해주세요");
      setDisabled(elGrade, true);
      renderOptions(null);

      if (!maker || !model){
        validate();
        return;
      }

      const grades = [...(gradesByMM.get(key2(maker, model)) ?? new Set())]
        .map(norm).filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,"ko"));

      fillSelect(elGrade, grades, "트림을 선택해주세요");
      setDisabled(elGrade, false);

      validate();
    });

    elGrade.addEventListener("change", ()=>{
      const maker = norm(elMaker.value);
      const model = norm(elModel.value);
      const grade = norm(elGrade.value);

      renderOptions(null);

      if (!maker || !model || !grade){
        validate();
        return;
      }

      const opts = [...(optionsByMMG.get(key3(maker, model, grade)) ?? new Set())]
        .map(norm).filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,"ko"));

      // 트림 선택 후 옵션 표시(없으면 안내 문구)
      renderOptions(opts);

      validate();
    });

    // 수입차/기타 입력 모드
    elManualModel.addEventListener("input", validate);
    elManualGrade.addEventListener("input", validate);
    elManualOption.addEventListener("input", validate);

    /***************************************************************
     * ✅ 입력 변화들
     ***************************************************************/
    elName.addEventListener("input", validate);
    elDeliveryTime.addEventListener("input", validate);
    elDeliveryArea.addEventListener("input", validate);
    elKakaoId.addEventListener("input", validate);
    elAgree.addEventListener("change", validate);

    elPhone.addEventListener("input", (e)=>{
      e.target.value = phoneFormatLoose(e.target.value);
      validate();
    });

    document.querySelectorAll('input[name="productType"], input[name="customerType"]').forEach(el=>{
      el.addEventListener("change", validate);
    });

    /***************************************************************
     * ✅ 제출
     * - option: "옵션1/옵션2" (없으면 무옵션)
     * - 수입차/기타: manualOption 텍스트 사용 (비었으면 무옵션)
     ***************************************************************/
    async function fetchJsonLoose(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      try{
        return { ok: res.ok, data: JSON.parse(text), rawText: text };
      }catch(e){
        return { ok:false, data:null, rawText:text, parseError:e };
      }
    }

    async function submitApplication(){
      if (!validate()){
        toast("필수 항목을 확인해주세요.");
        return;
      }

      elSubmit.disabled = true;
      elSubmit.textContent = "전송 중…";

      const maker = norm(elMaker.value);
      const isSpecial = SPECIAL_MAKERS.has(maker);

      // 차량 정보 결정
      let model = "", grade = "", option = "";

      if (isSpecial){
        model = norm(elManualModel.value);
        grade = norm(elManualGrade.value);
        option = norm(elManualOption.value) || "무옵션";
      }else{
        model = norm(elModel.value);
        grade = norm(elGrade.value);
        option = getSelectedOptionsSlash(); // 체크박스 -> / 구분
      }

      // 유입 경로 source (폼 URL에 ?source=xxx 붙이면 자동)
      const urlParams = new URLSearchParams(location.search);
      const source = norm(urlParams.get("source")) || "web";

      const payload = {
        action: "apply",
        source,
        productType: getCheckedValue("productType", "렌트"),
        maker,
        model,
        grade,
        option, // ✅ option 컬럼에 저장
        customerType: getCheckedValue("customerType", "개인"),
        name: norm(elName.value),
        phone: norm(elPhone.value),
        deliveryTime: norm(elDeliveryTime.value),
        deliveryArea: norm(elDeliveryArea.value),
        kakaoId: norm(elKakaoId.value),
        agreed: "true"
      };

      let ok = false;
      let message = "접수 완료! 곧 안내드릴게요.";

      // POST
      try{
        const r = await fetchJsonLoose(`${API_BASE}?action=apply`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if (r.data && (r.data.ok !== false)){
          ok = true;
          if (r.data.message) message = r.data.message;
        } else {
          throw new Error("POST failed");
        }
      }catch(e){
        // GET fallback
        try{
          const qs = new URLSearchParams(payload).toString();
          const r2 = await fetchJsonLoose(`${API_BASE}?${qs}`, { method:"GET", cache:"no-store" });
          if (r2.data && (r2.data.ok !== false)){
            ok = true;
            if (r2.data.message) message = r2.data.message;
          }
        }catch(e2){
          console.error(e2);
        }
      }

      if (ok){
        toast(message);

        // 개인정보만 초기화
        elName.value = "";
        elPhone.value = "";
        elDeliveryTime.value = "";
        elDeliveryArea.value = "";
        elKakaoId.value = "";
        elAgree.checked = false;

        // 옵션 체크 해제
        if (!isSpecial){
          renderOptions([...document.querySelectorAll('#optionsGrid input[name="optionsChk"]')].map(x=>x.value));
          // 위는 다시 렌더되면서 체크가 풀림
        } else {
          elManualOption.value = "";
        }

        // 라디오 기본
        const ct = document.querySelector('input[name="customerType"][value="개인"]');
        if (ct) ct.checked = true;

        const pt = document.querySelector('input[name="productType"][value="렌트"]');
        if (pt) pt.checked = true;

      }else{
        toast("전송 실패. 웹앱 배포/권한/응답(JSON) 확인해주세요.");
      }

      elSubmit.textContent = "간단 견적 요청하기";
      validate();
    }

    elSubmit.addEventListener("click", submitApplication);

    /***************************************************************
     * ✅ 시작
     ***************************************************************/
    (async function init(){
      validate();
      await fetchCatalog();
    })();
  </script>
</body>
</html>
